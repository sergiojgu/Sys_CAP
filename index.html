<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Control de asistencias y pagos - UE Bolivia Venezuela</title>
<style>
  :root{
    --bg:#f7f7f7; --card:#fff; --accent:#2e7d32; --btn:#4CAF50; --danger:#d9534f;
  }
  body{
    font-family:Arial,Helvetica,sans-serif;
    background:var(--bg);
    margin:0;
    color:#222;
    -webkit-font-smoothing:antialiased;
  }
  header{
    text-align:center;
    padding:18px 10px 6px;
  }
  h1{
    margin:0;
    font-size:20px;
    line-height:1.2;
    color:#333;
  }
  h1 .subtitulo{ 
    display:block; 
    font-size:20px; 
    color:#333; 
    margin-top:6px; 
  }

  /* Menu - buttons single column centered */
  #menu{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:10px;
    padding:18px;
  }
  #menu button{
    width: 88%;
    max-width: 300px;
    padding:10px 12px;
    font-size:16px;
    border-radius:10px;
    border:0;
    background:var(--btn);
    color:white;
    cursor:pointer;
    transition:transform .08s, background .12s;
  }
  #menu button:hover{ transform:translateY(-2px); background:#45a049; }

  /* Modules */
  .modulo{ display:none; padding:16px; max-width:820px; margin:0 auto; box-sizing:border-box; }
  .modulo.active{ display:block; }

  .row{ display:flex; gap:12px; flex-wrap:wrap; justify-content:center; align-items:center; margin-bottom:8px; }

  .formulario{
    background:var(--card);
    padding:14px;
    border-radius:10px;
    box-shadow:0 1px 6px rgba(0,0,0,.06);
  }
  .formulario input, .formulario select, .formulario textarea {
    width:84%;
    max-width:480px;
    padding:9px;
    margin:8px auto;
    font-size:15px;
    border-radius:8px;
    border:1px solid #ccc;
    display:block;
  }
  .form-btn {
    display:inline-block;
    background:var(--btn);
    color:white;
    border:0;
    padding:9px 12px;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
    margin-top:6px;
    transition: all 0.3s ease;
  }
  .form-btn:disabled{ opacity:.7; cursor:not-allowed; }
  .form-btn.saving {
    background: #666;
    transform: scale(0.98);
  }

  .mensaje-boton {
    display:inline-block;
    font-weight:700;
    color:var(--accent);
    margin-left:10px;
    font-size:14px;
  }

  input[type="text"].small, input[type="date"].small { width:180px; display:inline-block; margin-right:8px; }

  .lista {
    margin-top:14px;
    max-width:760px;
    margin-left:auto;
    margin-right:auto;
    text-align:left;
  }
  .item{
    background:#fff;
    padding:10px;
    border-radius:8px;
    box-shadow:0 1px 4px rgba(0,0,0,.06);
    margin-bottom:10px;
    cursor:pointer;
  }
  .item strong{ color:var(--btn); }
  .detalles{ display:none; margin-top:8px; border-top:1px solid #eee; padding-top:8px; font-size:14px; color:#333; }
  .acciones button{ margin-right:8px; padding:6px 8px; border-radius:6px; border:0; cursor:pointer; font-weight:600; }
  .acciones .edit{ background:#f0ad4e; color:#000; }
  .acciones .del{ background:var(--danger); color:white; }

  /* ESTILOS COMPLETAMENTE CORREGIDOS PARA LA LISTA DE PADRES */
  #listaPadresCheck {
    margin: 8px 0 0 0;
    padding: 0;
    text-align: left;
    width: 100%;
    display: block;
  }
  .check-item {
    padding: 6px 0;
    display: flex;
    align-items: center;
    margin: 0;
    width: 100%;
    justify-content: flex-start;
  }
  .check-item input {
    margin: 0 10px 0 0;
    width: auto;
    transform: scale(1.2);
    flex-shrink: 0;
  }
  .check-item label {
    cursor: pointer;
    font-size: 15px;
    margin: 0;
    display: block;
  }

  .volver {
    display:inline-block;
    margin-top:12px;
    background:#666;
    color:#fff;
    padding:8px 12px;
    border-radius:8px;
    border:0;
    cursor:pointer;
  }

  /* search inputs */
  .search {
    width:84%;
    max-width:480px;
    padding:8px;
    border-radius:8px;
    border:1px solid #ccc;
    display:block;
    margin:10px auto 6px;
  }

  /* Filtro de grupos en reuniones */
  .filtro-grupo {
    width: 84%;
    max-width: 480px;
    padding: 8px;
    border-radius: 8px;
    border: 1px solid #ccc;
    display: block;
    margin: 10px auto 6px;
    font-size: 15px;
  }

  /* Botón de exportar */
  .btn-exportar {
    display: inline-block;
    background: #2196F3;
    color: white;
    border: 0;
    padding: 9px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    margin-top: 6px;
    transition: all 0.3s ease;
  }
  .btn-exportar:hover {
    background: #0b7dda;
  }

  /* responsive tweaks */
  @media (max-width:520px){
    #menu button{ width:92%; font-size:15px; }
    .formulario input, .formulario select, .formulario textarea { width:94%; }
  }
</style>
</head>
<body>

<header>
  <h1>Control de asistencias y pagos<br><span class="subtitulo">UE Bolivia Venezuela</span></h1>
</header>

<!-- MENU -->
<div id="menu" aria-label="Menú principal">
  <button onclick="abrirModulo('alumnos')">Alumnos</button>
  <button onclick="abrirModulo('padres')">Padres</button>
  <button onclick="abrirModulo('grupos')">Grupos</button>
  <button onclick="abrirModulo('reuniones')">Reuniones</button>
  <button onclick="abrirModulo('pagos')">Pagos</button>
  <button class="btn-exportar" onclick="exportarDatos()">Exportar Datos a Excel</button>
</div>

<!-- ===== ALUMNOS ===== -->
<section id="alumnos" class="modulo" aria-hidden="true">
  <h2>Alumnos</h2>
  <div class="formulario" role="group" aria-label="Formulario alumnos">
    <input id="nombreAlumno" type="text" placeholder="Nombre completo">
    <select id="padreAlumno"><option value="">Seleccionar padre/tutor</option></select>
    <textarea id="comentariosAlumno" placeholder="Comentarios"></textarea>

    <div class="row" style="justify-content:center;">
      <button id="btnGuardarAlumno" class="form-btn" onclick="guardarAlumno(this)">Guardar</button>
      <span id="saveMsgAlumno" class="mensaje-boton" aria-live="polite" style="display:none"></span>
    </div>
  </div>

  <input id="buscarAlumno" class="search" type="text" placeholder="Buscar alumno (por nombre parcial)">
  <div id="listaAlumnos" class="lista" aria-live="polite"></div>
  <div style="text-align:center">
    <button class="btn-exportar" onclick="exportarAlumnosExcel()">Exportar Alumnos a Excel</button>
    <button class="volver" onclick="volverMenu()">Volver</button>
  </div>
</section>

<!-- ===== PADRES ===== -->
<section id="padres" class="modulo" aria-hidden="true">
  <h2>Padres / Tutores</h2>
  <div class="formulario" role="group">
    <input id="nombrePadre" type="text" placeholder="Nombre completo">
    <input id="telefonoPadre" type="text" placeholder="Teléfono">
    <select id="grupoPadre"><option value="">Seleccionar grupo</option></select>
    <div class="row" style="justify-content:center;">
      <button id="btnGuardarPadre" class="form-btn" onclick="guardarPadre(this)">Guardar</button>
      <span id="saveMsgPadre" class="mensaje-boton" style="display:none"></span>
    </div>
  </div>

  <input id="buscarPadre" class="search" type="text" placeholder="Buscar padre (por nombre)">
  <div id="listaPadres" class="lista" aria-live="polite"></div>
  <div style="text-align:center">
    <button class="btn-exportar" onclick="exportarPadresExcel()">Exportar Padres a Excel</button>
    <button class="volver" onclick="volverMenu()">Volver</button>
  </div>
</section>

<!-- ===== GRUPOS ===== -->
<section id="grupos" class="modulo" aria-hidden="true">
  <h2>Grupos</h2>
  <div class="formulario" role="group">
    <input id="nombreGrupo" type="text" placeholder="Nombre del grupo">
    <textarea id="descripcionGrupo" placeholder="Descripción (opcional)"></textarea>
    <div class="row" style="justify-content:center;">
      <button id="btnGuardarGrupo" class="form-btn" onclick="guardarGrupo(this)">Guardar</button>
      <span id="saveMsgGrupo" class="mensaje-boton" style="display:none"></span>
    </div>
  </div>

  <input id="buscarGrupo" class="search" type="text" placeholder="Buscar grupo">
  <div id="listaGrupos" class="lista" aria-live="polite"></div>
  <div style="text-align:center">
    <button class="btn-exportar" onclick="exportarGruposExcel()">Exportar Grupos a Excel</button>
    <button class="volver" onclick="volverMenu()">Volver</button>
  </div>
</section>

<!-- ===== REUNIONES ===== -->
<section id="reuniones" class="modulo" aria-hidden="true">
  <h2>Reuniones</h2>
  <div class="formulario" role="group" style="text-align: left;">
    <input id="tituloReunion" type="text" placeholder="Título de la reunión">
    <input id="fechaReunion" type="date">
    <input id="horaReunion" type="time">
    <textarea id="observacionesReunion" placeholder="Observaciones"></textarea>

    <h4 style="margin:8px 0 6px; text-align:left;">Seleccionar padres presentes:</h4>
    
    <!-- Filtro por grupos -->
    <select id="filtroGrupoReunion" class="filtro-grupo">
      <option value="">Todos los grupos</option>
    </select>
    
    <div id="listaPadresCheck" aria-label="Lista de padres con checkbox"></div>

    <div class="row" style="justify-content:center;">
      <button id="btnGuardarReunion" class="form-btn" onclick="guardarReunion(this)">Guardar reunión</button>
      <span id="saveMsgReunion" class="mensaje-boton" style="display:none"></span>
    </div>
  </div>

  <input id="buscarReunion" class="search" type="text" placeholder="Buscar reunión (por título)">
  <div id="listaReuniones" class="lista" aria-live="polite"></div>
  <div style="text-align:center">
    <button class="btn-exportar" onclick="exportarReunionesExcel()">Exportar Reuniones a Excel</button>
    <button class="volver" onclick="volverMenu()">Volver</button>
  </div>
</section>

<!-- ===== PAGOS ===== -->
<section id="pagos" class="modulo" aria-hidden="true">
  <h2>Pagos</h2>
  <div class="formulario" role="group">
    <select id="alumnoPago"><option value="">Seleccionar alumno</option></select>
    <input id="montoPago" type="number" placeholder="Monto (Bs)" min="0" step="0.01">
    <input id="fechaPago" type="date">
    <input id="conceptoPago" type="text" placeholder="Concepto / detalle">
    <div class="row" style="justify-content:center;">
      <button id="btnGuardarPago" class="form-btn" onclick="guardarPago(this)">Guardar pago</button>
      <span id="saveMsgPago" class="mensaje-boton" style="display:none"></span>
    </div>
  </div>

  <input id="buscarPago" class="search" type="text" placeholder="Buscar pagos (por alumno)">
  <div id="listaPagos" class="lista" aria-live="polite"></div>
  <div style="text-align:center">
    <button class="btn-exportar" onclick="exportarPagosExcel()">Exportar Pagos a Excel</button>
    <button class="volver" onclick="volverMenu()">Volver</button>
  </div>
</section>

<script>
/* -----------------------------------------
  Datos iniciales (arrays persistidos en localStorage)
----------------------------------------- */
let alumnos = JSON.parse(localStorage.getItem('alumnos') || '[]');
let padres = JSON.parse(localStorage.getItem('padres') || '[]');
let grupos = JSON.parse(localStorage.getItem('grupos') || '[]');
let reuniones = JSON.parse(localStorage.getItem('reuniones') || '[]');
let pagos = JSON.parse(localStorage.getItem('pagos') || '[]');

let editIndex = {
  alumno: null,
  padre: null,
  grupo: null,
  reunion: null,
  pago: null
};

/* -------------------------
  Util: mostrar mensaje en botón
  recibe el elemento botón (btnEl) y el texto temporal
------------------------- */
function tempSaved(btnEl, text='✅ Guardado', ms=2000){
  const original = btnEl.textContent;
  btnEl.textContent = text;
  btnEl.disabled = true;
  btnEl.classList.add('saving');
  setTimeout(() => { 
    btnEl.textContent = original; 
    btnEl.disabled = false; 
    btnEl.classList.remove('saving');
  }, ms);
}

/* -------------------------
  Navegación
------------------------- */
function abrirModulo(id){
  document.getElementById('menu').style.display='none';
  document.querySelectorAll('.modulo').forEach(m => m.classList.remove('active'));
  const sec = document.getElementById(id);
  sec.classList.add('active');
  // cuando abrimos, recargar datos útiles
  if(id==='alumnos'){ cargarPadresSelect(); mostrarAlumnos(); }
  if(id==='padres'){ cargarGruposSelect(); mostrarPadres(); }
  if(id==='grupos'){ mostrarGrupos(); }
  if(id==='reuniones'){ 
    cargarFiltroGruposReunion(); 
    cargarPadresCheck(); 
    mostrarReuniones(); 
  }
  if(id==='pagos'){ cargarAlumnosPago(); mostrarPagos(); }
}
function volverMenu(){
  document.querySelectorAll('.modulo').forEach(m => m.classList.remove('active'));
  document.getElementById('menu').style.display = 'flex';
}

/* -------------------------
  ALUMNOS
------------------------- */
function guardarAlumno(btn){
  const nombre = document.getElementById('nombreAlumno').value.trim();
  const padre = document.getElementById('padreAlumno').value;
  const comentarios = document.getElementById('comentariosAlumno').value.trim();
  if(!nombre) { alert('El nombre del alumno es obligatorio'); return; }

  if(editIndex.alumno !== null){
    alumnos[editIndex.alumno] = { nombre, padre, comentarios };
    editIndex.alumno = null;
  } else {
    alumnos.push({ nombre, padre, comentarios });
  }
  localStorage.setItem('alumnos', JSON.stringify(alumnos));
  tempSaved(btn);
  limpiarAlumno();
  mostrarAlumnos();
  cargarAlumnosPago(); // actualizar selector de pagos
}

function limpiarAlumno(){
  document.getElementById('nombreAlumno').value='';
  document.getElementById('padreAlumno').value='';
  document.getElementById('comentariosAlumno').value='';
}

function mostrarAlumnos(){
  const cont = document.getElementById('listaAlumnos');
  cont.innerHTML = '';
  const q = document.getElementById('buscarAlumno').value.trim().toLowerCase();
  const lista = alumnos.filter(a => !q || a.nombre.toLowerCase().includes(q));
  if(lista.length === 0){ cont.innerHTML = '<div class="item">No hay alumnos.</div>'; return; }
  lista.forEach((a, i) => {
    const idx = alumnos.indexOf(a);
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `<strong>${escapeHtml(a.nombre)}</strong>
      <div class="detalles">
        <p><b>Padre/Tutor:</b> ${escapeHtml(a.padre||'-')}</p>
        <p><b>Comentarios:</b> ${escapeHtml(a.comentarios||'-')}</p>
        <div class="acciones">
          <button class="edit" onclick="editarAlumno(${idx})">Editar</button>
          <button class="del" onclick="eliminarAlumno(${idx})">Eliminar</button>
        </div>
      </div>`;
    div.onclick = (e) => {
      // evitar toggle si se clickeó un botón interno
      if(e.target.tagName.toLowerCase() === 'button') return;
      const det = div.querySelector('.detalles');
      det.style.display = det.style.display === 'block' ? 'none' : 'block';
    };
    cont.appendChild(div);
  });
}

function editarAlumno(i){
  const a = alumnos[i];
  document.getElementById('nombreAlumno').value = a.nombre;
  document.getElementById('padreAlumno').value = a.padre || '';
  document.getElementById('comentariosAlumno').value = a.comentarios || '';
  editIndex.alumno = i;
  abrirModulo('alumnos');
}

function eliminarAlumno(i){
  if(confirm('Eliminar este alumno?')) {
    alumnos.splice(i,1);
    localStorage.setItem('alumnos', JSON.stringify(alumnos));
    mostrarAlumnos();
    cargarAlumnosPago();
  }
}
document.getElementById('buscarAlumno').addEventListener('input', mostrarAlumnos);

/* cargar padres en select (para Alumnos) */
function cargarPadresSelect(){
  const sel = document.getElementById('padreAlumno');
  sel.innerHTML = '<option value="">Seleccionar padre/tutor</option>';
  padres.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.nombre;
    opt.textContent = p.nombre;
    sel.appendChild(opt);
  });
}

/* -------------------------
  PADRES
------------------------- */
function guardarPadre(btn){
  const nombre = document.getElementById('nombrePadre').value.trim();
  const telefono = document.getElementById('telefonoPadre').value.trim();
  const grupo = document.getElementById('grupoPadre').value;
  if(!nombre){ alert('El nombre del padre/tutor es obligatorio'); return; }

  if(editIndex.padre !== null){
    padres[editIndex.padre] = { nombre, telefono, grupo };
    editIndex.padre = null;
  } else padres.push({ nombre, telefono, grupo });

  localStorage.setItem('padres', JSON.stringify(padres));
  tempSaved(btn);
  limpiarPadre();
  mostrarPadres();
  cargarPadresSelect(); // actualizar select de alumnos
  cargarPadresCheck();  // actualizar check list en reuniones
  cargarPadresEnSelect(); // actualizar pagos si usa padres
}

function limpiarPadre(){
  document.getElementById('nombrePadre').value='';
  document.getElementById('telefonoPadre').value='';
  document.getElementById('grupoPadre').value='';
}

function mostrarPadres(){
  const cont = document.getElementById('listaPadres');
  cont.innerHTML = '';
  const q = document.getElementById('buscarPadre').value.trim().toLowerCase();
  const lista = padres.filter(p => !q || p.nombre.toLowerCase().includes(q));
  if(lista.length === 0){ cont.innerHTML = '<div class="item">No hay padres/tutores.</div>'; return; }
  lista.forEach((p,i) => {
    const idx = padres.indexOf(p);
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `<strong>${escapeHtml(p.nombre)}</strong>
      <div class="detalles">
        <p><b>Teléfono:</b> ${escapeHtml(p.telefono||'-')}</p>
        <p><b>Grupo:</b> ${escapeHtml(p.grupo||'-')}</p>
        <div class="acciones">
          <button class="edit" onclick="editarPadre(${idx})">Editar</button>
          <button class="del" onclick="eliminarPadre(${idx})">Eliminar</button>
        </div>
      </div>`;
    div.onclick = (e) => {
      if(e.target.tagName.toLowerCase() === 'button') return;
      const det = div.querySelector('.detalles');
      det.style.display = det.style.display === 'block' ? 'none' : 'block';
    };
    cont.appendChild(div);
  });
}

function editarPadre(i){
  const p = padres[i];
  document.getElementById('nombrePadre').value = p.nombre;
  document.getElementById('telefonoPadre').value = p.telefono || '';
  document.getElementById('grupoPadre').value = p.grupo || '';
  editIndex.padre = i;
  abrirModulo('padres');
}

function eliminarPadre(i){
  if(confirm('Eliminar este padre/tutor?')){
    padres.splice(i,1);
    localStorage.setItem('padres', JSON.stringify(padres));
    mostrarPadres();
    cargarPadresSelect();
    cargarPadresCheck();
    cargarPadresEnSelect();
  }
}
document.getElementById('buscarPadre').addEventListener('input', mostrarPadres);

/* cargar grupos en select (para Padres) */
function cargarGruposSelect(){
  const sel = document.getElementById('grupoPadre');
  sel.innerHTML = '<option value="">Seleccionar grupo</option>';
  grupos.forEach(g=>{
    const opt = document.createElement('option');
    opt.value = g.nombre;
    opt.textContent = g.nombre;
    sel.appendChild(opt);
  });
}

/* -------------------------
  GRUPOS
------------------------- */
function guardarGrupo(btn){
  const nombre = document.getElementById('nombreGrupo').value.trim();
  const descripcion = document.getElementById('descripcionGrupo').value.trim();
  if(!nombre){ alert('El nombre del grupo es obligatorio'); return; }

  if(editIndex.grupo !== null){
    grupos[editIndex.grupo] = { nombre, descripcion };
    editIndex.grupo = null;
  } else grupos.push({ nombre, descripcion });

  localStorage.setItem('grupos', JSON.stringify(grupos));
  tempSaved(btn);
  limpiarGrupo();
  mostrarGrupos();
  cargarGruposSelect();
}

function limpiarGrupo(){
  document.getElementById('nombreGrupo').value='';
  document.getElementById('descripcionGrupo').value='';
}

function mostrarGrupos(){
  const cont = document.getElementById('listaGrupos');
  cont.innerHTML = '';
  const q = document.getElementById('buscarGrupo').value.trim().toLowerCase();
  const lista = grupos.filter(g => !q || g.nombre.toLowerCase().includes(q));
  if(lista.length === 0){ cont.innerHTML = '<div class="item">No hay grupos.</div>'; return; }
  lista.forEach((g,i)=>{
    const idx = grupos.indexOf(g);
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `<strong>${escapeHtml(g.nombre)}</strong>
      <div class="detalles">
        <p><b>Descripción:</b> ${escapeHtml(g.descripcion||'-')}</p>
        <div class="acciones">
          <button class="edit" onclick="editarGrupo(${idx})">Editar</button>
          <button class="del" onclick="eliminarGrupo(${idx})">Eliminar</button>
        </div>
      </div>`;
    div.onclick = (e) => {
      if(e.target.tagName.toLowerCase() === 'button') return;
      const det = div.querySelector('.detalles');
      det.style.display = det.style.display === 'block' ? 'none' : 'block';
    };
    cont.appendChild(div);
  });
}
function editarGrupo(i){
  const g = grupos[i];
  document.getElementById('nombreGrupo').value = g.nombre;
  document.getElementById('descripcionGrupo').value = g.descripcion || '';
  editIndex.grupo = i;
  abrirModulo('grupos');
}
function eliminarGrupo(i){
  if(confirm('Eliminar este grupo?')){
    grupos.splice(i,1);
    localStorage.setItem('grupos', JSON.stringify(grupos));
    mostrarGrupos();
    cargarGruposSelect();
  }
}
document.getElementById('buscarGrupo').addEventListener('input', mostrarGrupos);

/* -------------------------
  REUNIONES (padres check)
------------------------- */
function cargarFiltroGruposReunion() {
  const filtro = document.getElementById('filtroGrupoReunion');
  filtro.innerHTML = '<option value="">Todos los grupos</option>';
  grupos.forEach(g => {
    const opt = document.createElement('option');
    opt.value = g.nombre;
    opt.textContent = g.nombre;
    filtro.appendChild(opt);
  });
}

function cargarPadresCheck(presentes=[]){
  const cont = document.getElementById('listaPadresCheck');
  cont.innerHTML = '';
  if(padres.length === 0){ 
    cont.innerHTML = '<div class="item">No hay padres registrados.</div>'; 
    return; 
  }
  
  padres.forEach(p => {
    const div = document.createElement('div');
    div.className = 'check-item';
    div.setAttribute('data-grupo', p.grupo || '');
    const id = 'chk_'+slugify(p.nombre);
    div.innerHTML = `<input id="${id}" type="checkbox" value="${escapeHtml(p.nombre)}" ${presentes.includes(p.nombre) ? 'checked' : ''}> 
                     <label for="${id}">${escapeHtml(p.nombre)}</label>`;
    cont.appendChild(div);
  });
  
  // Aplicar filtro actual después de cargar
  filtrarPadresPorGrupo();
}

function filtrarPadresPorGrupo() {
  const filtro = document.getElementById('filtroGrupoReunion').value;
  const items = document.querySelectorAll('#listaPadresCheck .check-item');
  
  items.forEach(item => {
    const grupoPadre = item.getAttribute('data-grupo') || '';
    if (!filtro || grupoPadre === filtro) {
      item.style.display = 'flex';
    } else {
      item.style.display = 'none';
    }
  });
}

function guardarReunion(btn){
  const titulo = document.getElementById('tituloReunion').value.trim();
  const fecha = document.getElementById('fechaReunion').value;
  const hora = document.getElementById('horaReunion').value;
  const observaciones = document.getElementById('observacionesReunion').value.trim();
  const checkboxes = document.querySelectorAll('#listaPadresCheck input[type="checkbox"]');
  const presentes = [];
  const ausentes = [];
  
  checkboxes.forEach(cb => { 
    if(cb.checked) {
      presentes.push(cb.value);
    } else {
      ausentes.push(cb.value);
    }
  });

  if(!titulo){ alert('El título de la reunión es obligatorio'); return; }

  if(editIndex.reunion !== null){
    reuniones[editIndex.reunion] = { titulo, fecha, hora, observaciones, presentes, ausentes };
    editIndex.reunion = null;
  } else reuniones.push({ titulo, fecha, hora, observaciones, presentes, ausentes });

  localStorage.setItem('reuniones', JSON.stringify(reuniones));
  tempSaved(btn);
  limpiarReunion();
  mostrarReuniones();
}

function limpiarReunion(){
  document.getElementById('tituloReunion').value='';
  document.getElementById('fechaReunion').value='';
  document.getElementById('horaReunion').value='';
  document.getElementById('observacionesReunion').value='';
  document.getElementById('filtroGrupoReunion').value = '';
  cargarPadresCheck();
}

function mostrarReuniones(){
  const cont = document.getElementById('listaReuniones');
  cont.innerHTML = '';
  const q = document.getElementById('buscarReunion').value.trim().toLowerCase();
  const lista = reuniones.filter(r => !q || r.titulo.toLowerCase().includes(q));
  if(lista.length === 0){ cont.innerHTML = '<div class="item">No hay reuniones.</div>'; return; }
  lista.forEach((r,i) => {
    const idx = reuniones.indexOf(r);
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `<strong>${escapeHtml(r.titulo)}</strong>
      <div class="detalles">
        <p><b>Fecha:</b> ${escapeHtml(r.fecha||'-')}</p>
        <p><b>Hora:</b> ${escapeHtml(r.hora||'-')}</p>
        <p><b>Observaciones:</b> ${escapeHtml(r.observaciones||'-')}</p>
        <p><b>Presentes:</b> ${r.presentes && r.presentes.length ? escapeHtml(r.presentes.join(', ')) : '-'}</p>
        <p><b>Ausentes:</b> ${r.ausentes && r.ausentes.length ? escapeHtml(r.ausentes.join(', ')) : '-'}</p>
        <div class="acciones">
          <button class="edit" onclick="editarReunion(${idx})">Editar</button>
          <button class="del" onclick="eliminarReunion(${idx})">Eliminar</button>
        </div>
      </div>`;
    div.onclick = (e) => { 
      if(e.target.tagName.toLowerCase()==='button') return; 
      const det = div.querySelector('.detalles'); 
      det.style.display = det.style.display === 'block' ? 'none' : 'block'; 
    };
    cont.appendChild(div);
  });
}
function editarReunion(i){
  const r = reuniones[i];
  document.getElementById('tituloReunion').value = r.titulo;
  document.getElementById('fechaReunion').value = r.fecha || '';
  document.getElementById('horaReunion').value = r.hora || '';
  document.getElementById('observacionesReunion').value = r.observaciones || '';
  editIndex.reunion = i;
  abrirModulo('reuniones');
  cargarPadresCheck(r.presentes || []);
}
function eliminarReunion(i){
  if(confirm('Eliminar esta reunión?')){
    reuniones.splice(i,1);
    localStorage.setItem('reuniones', JSON.stringify(reuniones));
    mostrarReuniones();
  }
}
document.getElementById('buscarReunion').addEventListener('input', mostrarReuniones);

/* -------------------------
  PAGOS
------------------------- */
function cargarAlumnosPago(){
  const sel = document.getElementById('alumnoPago');
  sel.innerHTML = '<option value="">Seleccionar alumno</option>';
  alumnos.forEach(a => {
    const opt = document.createElement('option');
    opt.value = a.nombre;
    opt.textContent = a.nombre;
    sel.appendChild(opt);
  });
}

function guardarPago(btn){
  const alumno = document.getElementById('alumnoPago').value;
  const monto = document.getElementById('montoPago').value.trim();
  const fecha = document.getElementById('fechaPago').value;
  const concepto = document.getElementById('conceptoPago').value.trim();

  if(!alumno || !monto){ alert('Seleccionar alumno y monto'); return; }

  if(editIndex.pago !== null){
    pagos[editIndex.pago] = { alumno, monto, fecha, concepto };
    editIndex.pago = null;
  } else pagos.push({ alumno, monto, fecha, concepto });

  localStorage.setItem('pagos', JSON.stringify(pagos));
  tempSaved(btn);
  limpiarPago();
  mostrarPagos();
}

function limpiarPago(){
  document.getElementById('alumnoPago').value='';
  document.getElementById('montoPago').value='';
  document.getElementById('fechaPago').value='';
  document.getElementById('conceptoPago').value='';
}

function mostrarPagos(){
  const cont = document.getElementById('listaPagos');
  cont.innerHTML = '';
  const q = document.getElementById('buscarPago').value.trim().toLowerCase();
  const lista = pagos.filter(p => !q || p.alumno.toLowerCase().includes(q));
  if(lista.length === 0){ cont.innerHTML = '<div class="item">No hay pagos registrados.</div>'; return; }
  lista.forEach((p,i) => {
    const idx = pagos.indexOf(p);
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `<strong>${escapeHtml(p.alumno)}</strong> - ${escapeHtml(p.monto)}
      <div class="detalles">
        <p><b>Fecha:</b> ${escapeHtml(p.fecha||'-')}</p>
        <p><b>Concepto:</b> ${escapeHtml(p.concepto||'-')}</p>
        <div class="acciones">
          <button class="edit" onclick="editarPago(${idx})">Editar</button>
          <button class="del" onclick="eliminarPago(${idx})">Eliminar</button>
        </div>
      </div>`;
    div.onclick = (e) => { 
      if(e.target.tagName.toLowerCase()==='button') return; 
      const det = div.querySelector('.detalles'); 
      det.style.display = det.style.display === 'block' ? 'none' : 'block'; 
    };
    cont.appendChild(div);
  });
}
function editarPago(i){
  const p = pagos[i];
  document.getElementById('alumnoPago').value = p.alumno;
  document.getElementById('montoPago').value = p.monto;
  document.getElementById('fechaPago').value = p.fecha || '';
  document.getElementById('conceptoPago').value = p.concepto || '';
  editIndex.pago = i;
  abrirModulo('pagos');
}
function eliminarPago(i){
  if(confirm('Eliminar este pago?')){
    pagos.splice(i,1);
    localStorage.setItem('pagos', JSON.stringify(pagos));
    mostrarPagos();
  }
}
document.getElementById('buscarPago').addEventListener('input', mostrarPagos);

/* -------------------------
  FUNCIONES DE EXPORTACIÓN A EXCEL
------------------------- */
function exportarExcel(datos, nombreArchivo, columnas, nombresColumnas) {
  if (datos.length === 0) {
    alert(`No hay datos para exportar en ${nombreArchivo}`);
    return;
  }

  // Crear contenido HTML para Excel
  let html = `
    <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
    <head>
      <meta charset="UTF-8">
      <title>${nombreArchivo}</title>
      <!--[if gte mso 9]>
      <xml>
        <x:ExcelWorkbook>
          <x:ExcelWorksheets>
            <x:ExcelWorksheet>
              <x:Name>${nombreArchivo}</x:Name>
              <x:WorksheetOptions>
                <x:DisplayGridlines/>
              </x:WorksheetOptions>
            </x:ExcelWorksheet>
          </x:ExcelWorksheets>
        </x:ExcelWorkbook>
      </xml>
      <![endif]-->
      <style>
        table {
          border-collapse: collapse;
          width: 100%;
        }
        th {
          background-color: #4CAF50;
          color: white;
          font-weight: bold;
          padding: 8px;
          text-align: left;
          border: 1px solid #ddd;
        }
        td {
          padding: 8px;
          border: 1px solid #ddd;
        }
        tr:nth-child(even) {
          background-color: #f2f2f2;
        }
      </style>
    </head>
    <body>
      <table>
        <thead>
          <tr>
  `;

  // Agregar encabezados
  nombresColumnas.forEach(col => {
    html += `<th>${col}</th>`;
  });
  html += `</tr></thead><tbody>`;

  // Agregar datos
  datos.forEach(item => {
    html += '<tr>';
    columnas.forEach(col => {
      let valor = item[col] || '';
      // Si es un array, convertirlo a string
      if (Array.isArray(valor)) {
        valor = valor.join(', ');
      }
      html += `<td>${escapeHtml(valor)}</td>`;
    });
    html += '</tr>';
  });

  html += `</tbody></table></body></html>`;

  // Crear y descargar archivo
  const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', `${nombreArchivo}_${new Date().toISOString().split('T')[0]}.xls`);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function exportarAlumnosExcel() {
  const columnas = ['nombre', 'padre', 'comentarios'];
  const nombresColumnas = ['Nombre', 'Padre/Tutor', 'Comentarios'];
  exportarExcel(alumnos, 'alumnos', columnas, nombresColumnas);
}

function exportarPadresExcel() {
  const columnas = ['nombre', 'telefono', 'grupo'];
  const nombresColumnas = ['Nombre', 'Teléfono', 'Grupo'];
  exportarExcel(padres, 'padres', columnas, nombresColumnas);
}

function exportarGruposExcel() {
  const columnas = ['nombre', 'descripcion'];
  const nombresColumnas = ['Nombre', 'Descripción'];
  exportarExcel(grupos, 'grupos', columnas, nombresColumnas);
}

function exportarReunionesExcel() {
  const columnas = ['titulo', 'fecha', 'hora', 'observaciones', 'presentes', 'ausentes'];
  const nombresColumnas = ['Título', 'Fecha', 'Hora', 'Observaciones', 'Presentes', 'Ausentes'];
  exportarExcel(reuniones, 'reuniones', columnas, nombresColumnas);
}

function exportarPagosExcel() {
  const columnas = ['alumno', 'monto', 'fecha', 'concepto'];
  const nombresColumnas = ['Alumno', 'Monto (Bs)', 'Fecha', 'Concepto'];
  exportarExcel(pagos, 'pagos', columnas, nombresColumnas);
}

function exportarDatos() {
  if (confirm('¿Exportar todos los datos a archivos Excel? Se descargarán 5 archivos.')) {
    exportarAlumnosExcel();
    setTimeout(() => exportarPadresExcel(), 300);
    setTimeout(() => exportarGruposExcel(), 600);
    setTimeout(() => exportarReunionesExcel(), 900);
    setTimeout(() => exportarPagosExcel(), 1200);
  }
}

/* -------------------------
  UTILIDADES
------------------------- */
function escapeHtml(str){
  if(!str && str !== 0) return '';
  return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
}
function slugify(s){ return (s||'').toLowerCase().replace(/\s+/g,'_').replace(/[^\w\-]+/g,''); }

/* cargar selects globales */
function cargarPadresEnSelect(){
  // for payments if you want parents - not used currently but available
  const sel = document.getElementById('padrePago');
  if(!sel) return;
  sel.innerHTML = '<option value="">Seleccione un padre</option>';
  padres.forEach(p => {
    const o = document.createElement('option'); o.value = p.nombre; o.textContent = p.nombre; sel.appendChild(o);
  });
}

/* Inicializar pantallas con datos guardados */
document.addEventListener('DOMContentLoaded', () => {
  // populate basic lists so when user opens a module they see current data
  cargarPadresSelect();
  cargarGruposSelect();
  cargarFiltroGruposReunion();
  cargarPadresCheck();
  cargarAlumnosPago();
  mostrarAlumnos();
  mostrarPadres();
  mostrarGrupos();
  mostrarReuniones();
  mostrarPagos();
  
  // Event listener para el filtro de grupos en reuniones
  document.getElementById('filtroGrupoReunion').addEventListener('change', filtrarPadresPorGrupo);
});
</script>
</body>
</html>