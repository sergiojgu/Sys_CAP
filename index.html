<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Control de asistencias y pagos - UE Bolivia Venezuela</title>
<style>
  :root{
    --bg:#f7f7f7; --card:#fff; --accent:#2e7d32; --btn:#4CAF50; --danger:#d9534f;
    --warning: #f0ad4e;
    --menu-header-bg: #f2f3f4;
  }
  body{
    font-family:Arial,Helvetica,sans-serif;
    background:var(--bg);
    margin:0;
    color:#222;
    -webkit-font-smoothing:antialiased;
  }
  header{
    text-align:center;
    padding:18px 10px 6px;
  }
  h1{
    margin:0;
    font-size:20px;
    line-height:1.2;
    color:#333;
  }
  h1 .subtitulo{ 
    display:block; 
    font-size:20px; 
    color:#333; 
    margin-top:6px; 
  }

  /* Login */
  #loginScreen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
  }
  #loginScreen input {
    padding: 8px;
    margin: 5px;
    border: 1px solid #ccc;
    border-radius: 8px;
    width: 220px;
    font-size: 16px;
  }
  #loginScreen button {
    background: var(--btn);
    border: 0;
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    margin-top: 10px;
    cursor: pointer;
  }
  #loginBlankButton {
    background: var(--btn);
    border: 0;
    color: white;
    padding: 12px 18px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
  }
  #loginError {
    color: red;
    font-weight: bold;
    margin-top: 10px;
  }

  /* Menú principal */
  #menu{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:10px;
    padding:18px;
  }

  /* Encabezado del usuario conectado (fijo en la parte superior del menú) */
  .menu-header {
    position: -webkit-sticky;
    position: sticky;
    top: 8px;
    width: 100%;
    max-width: 340px;
    background: var(--menu-header-bg);
    padding:12px;
    border-radius:10px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    text-align:left;
    z-index: 50;
    display: none; /* se muestra sólo si hay usuario activo */
  }
  .menu-header b { display:block; margin-bottom:6px; font-size:15px; }
  .menu-header small { display:block; color:#444; margin-bottom:8px; }
  .menu-header .logout-small {
    display:inline-block;
    background:#fff;
    border:1px solid #ccc;
    padding:6px 8px;
    border-radius:8px;
    cursor:pointer;
    font-size:13px;
  }

  #menu button{
    width: 88%;
    max-width: 300px;
    padding:10px 12px;
    font-size:16px;
    border-radius:10px;
    border:0;
    background:var(--btn);
    color:white;
    cursor:pointer;
    transition:transform .08s, background .12s;
  }
  #menu button:hover{ transform:translateY(-2px); background:#45a049; }

  .modulo{ display:none; padding:16px; max-width:820px; margin:0 auto; }
  .modulo.active{ display:block; }

  .formulario{
    background:var(--card);
    padding:14px;
    border-radius:10px;
    box-shadow:0 1px 6px rgba(0,0,0,.06);
  }

  .formulario input, .formulario select, .formulario textarea {
    width:84%;
    max-width:480px;
    padding:9px;
    margin:8px auto;
    font-size:15px;
    border-radius:8px;
    border:1px solid #ccc;
    display:block;
  }

  .form-btn {
    display:inline-block;
    background:var(--btn);
    color:white;
    border:0;
    padding:9px 12px;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
    margin-top:6px;
  }

  .volver {
    display:inline-block;
    margin-top:12px;
    background:#666;
    color:#fff;
    padding:8px 12px;
    border-radius:8px;
    border:0;
    cursor:pointer;
  }

  .search {
    width:84%;
    max-width:480px;
    padding:8px;
    border-radius:8px;
    border:1px solid #ccc;
    display:block;
    margin:10px auto 6px;
  }

  .btn-exportar {
    display: inline-block;
    background: #2196F3;
    color: white;
    border: 0;
    padding: 9px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    margin-top: 6px;
  }

  /* Notificaciones */
  #notificacion {
    position: fixed;
    bottom: 12px;
    left: 50%;
    transform: translateX(-50%);
    background: #444;
    color: #fff;
    padding: 10px 20px;
    border-radius: 10px;
    font-size: 14px;
    display: none;
    box-shadow: 0 2px 6px rgba(0,0,0,.2);
    z-index: 1000;
  }

  /* Estilos para elementos de lista */
  .item {
    background:#f9f9f9;
    margin:8px 0;
    padding:8px 10px;
    border-radius:8px;
    box-shadow:0 1px 3px rgba(0,0,0,.05);
    position: relative;
  }
  .item-actions {
    position: absolute;
    right: 10px;
    top: 10px;
    display: flex;
    gap: 5px;
  }
  .btn-edit {
    background: var(--warning);
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
  }
  .btn-delete {
    background: var(--danger);
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
  }
  .btn-clear {
    background: var(--danger);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    margin: 10px 0;
  }

  /* Responsive small */
  @media (max-width:420px){
    #menu button{ width:92%; max-width: none; }
    .menu-header { max-width: 92%; }
  }
</style>
</head>
<body>

<!-- Pantalla original de login (se reemplaza en logout por pantalla limpia) -->
<div id="loginScreen">
  <h2>Iniciar sesión</h2>
  <input type="text" id="loginUser" placeholder="Usuario" value="root" />
  <input type="password" id="loginPass" placeholder="Contraseña" value="toor" />
  <button onclick="login()">Entrar</button>
  <div id="loginError"></div>
  <div style="margin-top: 20px; font-size: 12px; color: #666; text-align: center;">
    <p><strong>codigo Chikito - SGA Labs ©</strong></p>
  </div>
</div>

<header id="mainHeader" style="display:none;">
  <h1>Control de asistencias y pagos<br><span class="subtitulo">UE Bolivia Venezuela</span></h1>
</header>

<!-- MENÚ: aquí insertamos el encabezado fijo arriba del menú -->
<div id="menu" style="display:none;">
  <!-- encabezado del usuario conectado (se mostrará cuando exista usuarioActivo) -->
  <div id="menuHeader" class="menu-header" style="display:none;">
    <b id="mhUser">Usuario: —</b>
    <small id="mhRole">Rol: —</small>
    <small id="mhGrado">Grado: —</small>
    <div style="margin-top:8px;">
      <button class="logout-small" onclick="logoutAndShowBlank()">Cerrar sesión</button>
    </div>
  </div>

  <button onclick="abrirModulo('alumnos')">Alumnos</button>
  <button onclick="abrirModulo('padres')">Padres</button>
  <button onclick="abrirModulo('grupos')">Grupos</button>
  <button onclick="abrirModulo('reuniones')">Reuniones</button>
  <button onclick="abrirModulo('pagos')">Pagos</button>
  <button onclick="abrirModulo('usuarios')">Usuarios</button>
  <button onclick="abrirModulo('bitacora')">Bitácora</button>
  <button class="btn-exportar" onclick="exportarDatos()">Exportar Datos</button>
  <button class="volver" onclick="logoutAndShowBlank()">Cerrar sesión</button>
</div>

<div id="notificacion"></div>

<!-- ===== ALUMNOS ===== -->
<section id="alumnos" class="modulo">
  <h2>Alumnos</h2>
  <div class="formulario">
    <input id="nombreAlumno" type="text" placeholder="Nombre completo">
    <select id="padreAlumno"><option value="">Seleccionar padre/tutor</option></select>
    
    <textarea id="comentariosAlumno" placeholder="Comentarios"></textarea>

    <div style="text-align:center;">
      <button class="form-btn" id="btnGuardarAlumno" onclick="guardarAlumno()">Guardar</button>
      <button class="form-btn" onclick="mostrarAlumnos()">Actualizar</button>
    </div>
  </div>

  <input id="buscarAlumno" class="search" type="text" placeholder="Buscar alumno">
  <div id="listaAlumnos" class="lista"></div>
  <div style="text-align:center">
    <button class="btn-exportar" onclick="exportarAlumnos()">Exportar Alumnos</button>
    <button class="volver" onclick="volverMenu()">Volver</button>
  </div>
</section>

<!-- ===== PADRES ===== -->
<section id="padres" class="modulo">
  <h2>Padres / Tutores</h2>
  <div class="formulario">
    <input id="nombrePadre" type="text" placeholder="Nombre completo">
    <input id="telefonoPadre" type="text" placeholder="Teléfono">
    <select id="grupoPadre"><option value="">Seleccionar grupo</option></select>

    <div style="text-align:center;">
      <button class="form-btn" id="btnGuardarPadre" onclick="guardarPadre()">Guardar</button>
      <button class="form-btn" onclick="mostrarPadres()">Actualizar</button>
    </div>
  </div>

  <input id="buscarPadre" class="search" type="text" placeholder="Buscar padre">
  <div id="listaPadres" class="lista"></div>
  <div style="text-align:center">
    <button class="btn-exportar" onclick="exportarPadres()">Exportar Padres</button>
    <button class="volver" onclick="volverMenu()">Volver</button>
  </div>
</section>

<!-- ===== GRUPOS ===== -->
<section id="grupos" class="modulo">
  <h2>Grupos</h2>
  <div class="formulario">
    <input id="nombreGrupo" type="text" placeholder="Nombre del grupo">
    <textarea id="descripcionGrupo" placeholder="Descripción"></textarea>

    <div style="text-align:center;">
      <button class="form-btn" id="btnGuardarGrupo" onclick="guardarGrupo()">Guardar</button>
      <button class="form-btn" onclick="mostrarGrupos()">Actualizar</button>
    </div>
  </div>

  <input id="buscarGrupo" class="search" type="text" placeholder="Buscar grupo">
  <div id="listaGrupos" class="lista"></div>
  <div style="text-align:center">
    <button class="btn-exportar" onclick="exportarGrupos()">Exportar Grupos</button>
    <button class="volver" onclick="volverMenu()">Volver</button>
  </div>
</section>

<!-- ===== REUNIONES ===== -->
<section id="reuniones" class="modulo">
  <h2>Reuniones</h2>
  <div class="formulario">
    <input id="tituloReunion" type="text" placeholder="Título de la reunión">
    <input id="fechaReunion" type="date">
    <input id="horaReunion" type="time">
    <textarea id="observacionesReunion" placeholder="Observaciones"></textarea>
    <select id="grupoReunion">
      <option value="">Seleccionar grupo</option>
    </select>
    <h4>Seleccionar padres presentes:</h4>
    <div id="listaPadresCheck"></div>

    <div style="text-align:center;">
      <button class="form-btn" id="btnGuardarReunion" onclick="guardarReunion()">Guardar</button>
      <button class="form-btn" onclick="mostrarReuniones()">Actualizar</button>
    </div>
  </div>

  <input id="buscarReunion" class="search" type="text" placeholder="Buscar reunión">
  <div id="listaReuniones" class="lista"></div>
  <div style="text-align:center">
    <button class="btn-exportar" onclick="exportarReuniones()">Exportar Reuniones</button>
    <button class="volver" onclick="volverMenu()">Volver</button>
  </div>
</section>

<!-- ===== PAGOS ===== -->
<section id="pagos" class="modulo">
  <h2>Pagos</h2>
  <div class="formulario">
    <select id="padrePago"><option value="">Seleccionar padre</option></select>
    <input id="montoPago" type="number" placeholder="Monto (Bs)">
    <input id="fechaPago" type="date">
    <input id="conceptoPago" type="text" placeholder="Concepto / detalle">
    <div style="text-align:center;">
      <button class="form-btn" id="btnGuardarPago" onclick="guardarPago()">Guardar</button>
      <button class="form-btn" onclick="mostrarPagos()">Actualizar</button>
    </div>
  </div>

  <input id="buscarPago" class="search" type="text" placeholder="Buscar pago (por padre)">
  <div id="listaPagos" class="lista"></div>
  <div style="text-align:center">
    <button class="btn-exportar" onclick="exportarPagos()">Exportar Pagos</button>
    <button class="volver" onclick="volverMenu()">Volver</button>
  </div>
</section>

<!-- ===== USUARIOS ===== -->
<section id="usuarios" class="modulo">
  <h2>Gestión de usuarios</h2>
  <div class="formulario" id="formularioUsuario" style="display:none;">
    <input id="nombreUsuario" type="text" placeholder="Usuario">
    <input id="passUsuario" type="password" placeholder="Contraseña">
    <input id="telefonoUsuario" type="text" placeholder="Teléfono (ej: 591XXXXXXXX)" value="591">
    <select id="rolUsuario">
      <!-- Las opciones se cargarán dinámicamente según el rol del usuario -->
    </select>
    <select id="gradoUsuario">
      <option value="">Seleccionar grado</option>
    </select>
    <div style="text-align:center;">
      <button class="form-btn" id="btnGuardarUsuario" onclick="guardarUsuario()">Guardar</button>
      <button class="form-btn" onclick="cancelarEdicionUsuario()">Cancelar</button>
    </div>
  </div>

  <div style="text-align:center; margin-bottom: 15px;" id="botonNuevoUsuarioContainer">
    <button class="form-btn" onclick="nuevoUsuario()" id="btnNuevoUsuario">Nuevo Usuario</button>
  </div>

  <input id="buscarUsuario" class="search" type="text" placeholder="Buscar usuario">
  <div id="listaUsuarios" class="lista"></div>
  <div style="text-align:center">
    <button class="volver" onclick="volverMenu()">Volver</button>
  </div>
</section>

<!-- ===== BITÁCORA ===== -->
<section id="bitacora" class="modulo">
  <h2>Bitácora del sistema</h2>
  <div id="logContainer" style="background:#fff; padding:12px; border-radius:10px; box-shadow:0 1px 4px rgba(0,0,0,.1);">
    <div id="bitacoraLista" style="max-height:400px; overflow:auto; font-family:monospace; white-space:pre-wrap;"></div>
  </div>
  <div style="text-align:center">
    <button class="volver" onclick="volverMenu()">Volver</button>
  </div>
</section>

<script>
// ========== CONFIGURACIÓN INICIAL ==========
console.log("Inicializando sistema...");

/* === CONFIGURACIÓN DE GITHUB === */
const GITHUB_CONFIG = {
  token: '',
  owner: '',
  repo: '',
  dataFile: 'datos_sistema.json'
};

// ========== INICIALIZACIÓN DE DATOS ==========
// Cargar datos desde localStorage o inicializar arrays vacíos
let alumnos = JSON.parse(localStorage.getItem('alumnos') || '[]');
let padres = JSON.parse(localStorage.getItem('padres') || '[]');
let grupos = JSON.parse(localStorage.getItem('grupos') || '[]');
let reuniones = JSON.parse(localStorage.getItem('reuniones') || '[]');
let pagos = JSON.parse(localStorage.getItem('pagos') || '[]');
let bitacora = JSON.parse(localStorage.getItem('bitacora') || '[]');
let usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');

// Inicializar usuarios si no existen (los roles actuales aceptan variantes, mantener compatibilidad)
if (usuarios.length === 0) {
  usuarios = [
    { user: 'root', pass: 'toor', rol: 'superusuario', grado: 'Todos', telefono: '591' },
    { user: 'admin3A', pass: '123', rol: 'admin', grado: '3A', telefono: '591' },
    { user: 'oper3A', pass: '123', rol: 'operador', grado: '3A', telefono: '591' },
    { user: 'visita3A', pass: '123', rol: 'visitante', grado: '3A', telefono: '591' },
    { user: 'admin3B', pass: '123', rol: 'admin', grado: '3B', telefono: '591' }
  ];
  localStorage.setItem('usuarios', JSON.stringify(usuarios));
}

// Inicializar grupos si no existen -> vacío por diseño
if (grupos.length === 0) {
  grupos = []; // inicialmente vacío - los administradores agregarán grupos
  localStorage.setItem('grupos', JSON.stringify(grupos));
}

let usuarioActivo = JSON.parse(localStorage.getItem('usuarioActivo') || 'null');

// Role aliases (compatibilidad con nombres previos)
const ROLE_ALIASES = { SUPER: ['superadmin','superusuario'], ADMIN: ['administrador','admin'], OPER: ['operador'], VISIT: ['visitante'] };

// Variables para edición
let editandoIndex = -1;
let moduloEditando = '';

console.log("Datos cargados:", {
  alumnos: alumnos.length,
  padres: padres.length,
  grupos: grupos.length,
  reuniones: reuniones.length,
  pagos: pagos.length,
  bitacora: bitacora.length,
  usuarios: usuarios.length,
  usuarioActivo: usuarioActivo
});

// ======= UTILIDADES: RENDER MENU HEADER =======
function renderMenuHeader(){
  const mh = document.getElementById('menuHeader');
  if(!mh) return;
  if(!usuarioActivo){
    mh.style.display = 'none';
    return;
  }
  document.getElementById('mhUser').innerText = `Usuario: ${usuarioActivo.user}`;
  document.getElementById('mhRole').innerText = `Rol: ${usuarioActivo.rol}`;
  document.getElementById('mhGrado').innerText = `Grado: ${usuarioActivo.grado || '-'}`;
  mh.style.display = 'block';
}

// ========== SISTEMA DE LOGIN ==========
function login(){
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value.trim();
  const user = usuarios.find(x => x.user === u && x.pass === p);
  
  if(!user){
    document.getElementById('loginError').innerText = 'Usuario o contraseña incorrectos';
    return;
  }
  
  usuarioActivo = user;
  localStorage.setItem('usuarioActivo', JSON.stringify(user));
  registrarAccion(`Inició sesión en el sistema`);
  
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('mainHeader').style.display = 'block';
  document.getElementById('menu').style.display = 'flex';
  
  configurarVisibilidadPorRol();
  renderMenuHeader();
  mostrarNotificacion(`Bienvenido ${user.user} (${user.rol})`);
}

// Logout tradicional (vuelve a la pantalla de login original)
function logout(){
  if(usuarioActivo){
    registrarAccion(`Cerró sesión`);
  }
  usuarioActivo = null;
  localStorage.removeItem('usuarioActivo');
  
  // Restaurar pantalla de login original (con inputs)
  // Para simplicidad, recargar la página restaura todo al estado inicial
  location.reload();
}

// Logout solicitado: limpiar sesión y mostrar pantalla en blanco con botón "Iniciar sesión"
function logoutAndShowBlank(){
  if(usuarioActivo){
    registrarAccion(`Cerró sesión`);
  }
  usuarioActivo = null;
  localStorage.removeItem('usuarioActivo');
  
  // Ocultar todo lo demás
  document.getElementById('menu').style.display='none';
  document.getElementById('mainHeader').style.display='none';
  
  // Mostrar pantalla limpia con botón "Iniciar sesión" que recarga la página
  const login = document.getElementById('loginScreen');
  login.style.display = 'flex';
  login.innerHTML = `
    <div style="text-align:center; padding:40px;">
      <h2>Sesión cerrada</h2>
      <p style="color:#666; margin-bottom:18px;">Pulsa para iniciar sesión</p>
      <button id="loginBlankButton" onclick="location.reload()">Iniciar sesión</button>
    </div>
  `;
  document.getElementById('notificacion').style.display = 'none';
}

// Control de visibilidad por rol
function configurarVisibilidadPorRol(){
  const rol = usuarioActivo ? usuarioActivo.rol : null;
  const isSuper = ROLE_ALIASES.SUPER.includes(rol);
  const isAdmin = ROLE_ALIASES.ADMIN.includes(rol);
  const isOper = ROLE_ALIASES.OPER.includes(rol);
  const isVisit = ROLE_ALIASES.VISIT.includes(rol);

  const botonUsuarios = document.querySelector("button[onclick*='usuarios']");
  const botonBitacora = document.querySelector("button[onclick*='bitacora']");

  if(isVisit || isOper){
    if(botonUsuarios) botonUsuarios.style.display='none';
    if(botonBitacora) botonBitacora.style.display='none';
    return;
  }
  if(isSuper){
    if(botonUsuarios) botonUsuarios.style.display='block';
    if(botonBitacora) botonBitacora.style.display='block';
    return;
  }
  if(isAdmin){
    if(botonUsuarios) botonUsuarios.style.display='block';
    if(botonBitacora) botonBitacora.style.display='block';
    return;
  }
}


// ========== NOTIFICACIONES ==========
function mostrarNotificacion(msg){
  const n = document.getElementById('notificacion');
  n.textContent = msg;
  n.style.display = 'block';
  setTimeout(()=>{ n.style.display = 'none'; }, 3000);
}

// ========== GESTIÓN DE DATOS ==========
async function guardarDatos(){
  localStorage.setItem('alumnos', JSON.stringify(alumnos));
  localStorage.setItem('padres', JSON.stringify(padres));
  localStorage.setItem('grupos', JSON.stringify(grupos));
  localStorage.setItem('reuniones', JSON.stringify(reuniones));
  localStorage.setItem('pagos', JSON.stringify(pagos));
  localStorage.setItem('usuarios', JSON.stringify(usuarios));
  localStorage.setItem('bitacora', JSON.stringify(bitacora));
}

// ========== BITÁCORA ==========
function registrarAccion(texto){
  const fecha = new Date().toLocaleString();
  const usuario = usuarioActivo ? usuarioActivo.user : 'sistema';
  bitacora.unshift({ fecha, usuario, texto });
  if(bitacora.length > 300) bitacora.pop();
  mostrarBitacora();
  guardarDatos();
}

function mostrarBitacora(){
  const cont = document.getElementById('bitacoraLista');
  cont.innerHTML = '';
  
  // Botón para limpiar bitácora (solo para superusuario y admin)
  if (usuarioActivo && (ROLE_ALIASES.SUPER.includes(usuarioActivo.rol) || ROLE_ALIASES.ADMIN.includes(usuarioActivo.rol))) {
    const btnLimpiar = document.createElement('button');
    btnLimpiar.textContent = 'Limpiar Bitácora';
    btnLimpiar.className = 'btn-clear';
    btnLimpiar.onclick = limpiarBitacora;
    cont.appendChild(btnLimpiar);
  }
  
  if (bitacora.length === 0) {
    cont.innerHTML = '<div class="item">No hay registros en la bitácora.</div>';
    return;
  }
  
  bitacora.forEach((b, index) => {
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `<b>${b.fecha}</b> - ${b.usuario}: ${b.texto}`;
    
    // Botones de acción (solo para superusuario y admin)
    if (usuarioActivo && (ROLE_ALIASES.SUPER.includes(usuarioActivo.rol) || ROLE_ALIASES.ADMIN.includes(usuarioActivo.rol))) {
      const acciones = document.createElement('div');
      acciones.className = 'item-actions';
      
      const btnEliminar = document.createElement('button');
      btnEliminar.textContent = 'Eliminar';
      btnEliminar.className = 'btn-delete';
      btnEliminar.onclick = () => eliminarRegistroBitacora(index);
      acciones.appendChild(btnEliminar);
      
      div.appendChild(acciones);
    }
    
    cont.appendChild(div);
  });
}

function limpiarBitacora() {
  if (!usuarioActivo || (!ROLE_ALIASES.ADMIN.includes(usuarioActivo.rol) && !ROLE_ALIASES.SUPER.includes(usuarioActivo.rol))) {
    mostrarNotificacion('❌ No tienes permisos para limpiar la bitácora');
    return;
  }
  
  if (confirm('¿Estás seguro de que deseas limpiar toda la bitácora? Esta acción no se puede deshacer.')) {
    bitacora = [];
    registrarAccion('Limpio toda la bitácora');
    guardarDatos();
    mostrarBitacora();
    mostrarNotificacion('✅ Bitácora limpiada correctamente');
  }
}

function eliminarRegistroBitacora(index) {
  if (!usuarioActivo || (!ROLE_ALIASES.ADMIN.includes(usuarioActivo.rol) && !ROLE_ALIASES.SUPER.includes(usuarioActivo.rol))) {
    mostrarNotificacion('❌ No tienes permisos para eliminar registros de la bitácora');
    return;
  }
  
  const registro = bitacora[index];
  if (confirm(`¿Estás seguro de eliminar este registro: "${registro.texto}"?`)) {
    bitacora.splice(index, 1);
    registrarAccion(`Eliminó registro de bitácora: ${registro.texto.substring(0, 50)}...`);
    guardarDatos();
    mostrarBitacora();
    mostrarNotificacion('✅ Registro eliminado correctamente');
  }
}

// ========== NAVEGACIÓN ==========
function abrirModulo(id){
  document.querySelectorAll('.modulo').forEach(m=>m.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.getElementById('menu').style.display='none';
  
  // Resetear estado de edición
  editandoIndex = -1;
  moduloEditando = '';
  
  if(id === 'alumnos') { 
    mostrarAlumnos(); 
    cargarPadresSelect(); 
  }
  if(id === 'padres') { 
    mostrarPadres(); 
  }
  if(id === 'grupos') mostrarGrupos();
  if(id === 'reuniones') { 
    mostrarReuniones(); 
    cargarGrupoReunionSelect();
    cargarPadresCheck(); 
  }
  if(id === 'pagos') { 
    mostrarPagos(); 
    cargarPadresPagoSelect(); 
  }
  if(id === 'usuarios') { 
    mostrarUsuarios(); 
    // Asegurar que el formulario esté oculto al entrar
    document.getElementById('formularioUsuario').style.display = 'none';
    document.getElementById('botonNuevoUsuarioContainer').style.display = 
      (usuarioActivo && (ROLE_ALIASES.SUPER.includes(usuarioActivo.rol) || ROLE_ALIASES.ADMIN.includes(usuarioActivo.rol))) ? 'block' : 'none';
  }
  if(id === 'bitacora') mostrarBitacora();
  
  window.scrollTo(0,0);
}

function volverMenu(){
  document.querySelectorAll('.modulo').forEach(m=>m.classList.remove('active'));
  document.getElementById('menu').style.display='flex';
}

// ========== MÓDULOS (ALUMNOS/PADRES/GRUPOS/REUNIONES/PAGOS/USUARIOS) ==========
// (Mantengo tus funciones previas, ligeros ajustes para usar ROLE_ALIASES y para que grupo esté vacío)
function guardarAlumno(){
  if(usuarioActivo && ROLE_ALIASES.VISIT.includes(usuarioActivo.rol)) return mostrarNotificacion('Sin permiso para guardar');
  
  const nombre = document.getElementById('nombreAlumno').value.trim();
  const padre = document.getElementById('padreAlumno').value;
  const grado = (usuarioActivo && usuarioActivo.grado && !ROLE_ALIASES.SUPER.includes(usuarioActivo.rol)) ? usuarioActivo.grado : 'Todos';
  const comentarios = document.getElementById('comentariosAlumno').value.trim();
  
  if(!nombre) return mostrarNotificacion('Completar campos obligatorios');
  
  if (editandoIndex !== -1 && moduloEditando === 'alumnos') {
    alumnos[editandoIndex] = { nombre, padre, grado, comentarios };
    registrarAccion(`Editó alumno: ${nombre} (${grado})`);
    mostrarNotificacion('✅ Alumno actualizado correctamente');
    editandoIndex = -1;
    moduloEditando = '';
  } else {
    alumnos.push({ nombre, padre, grado, comentarios });
    registrarAccion(`Nuevo alumno: ${nombre} (${grado})`);
    mostrarNotificacion('✅ Alumno agregado correctamente');
  }
  
  guardarDatos();
  mostrarAlumnos();
  limpiarFormularioAlumno();
}

function limpiarFormularioAlumno() {
  document.getElementById('nombreAlumno').value = '';
  document.getElementById('padreAlumno').value = '';
  document.getElementById('comentariosAlumno').value = '';
}

function mostrarAlumnos(){
  const cont = document.getElementById('listaAlumnos');
  const q = document.getElementById('buscarAlumno').value?.toLowerCase() || '';
  cont.innerHTML = '';
  
  alumnos.filter(a => a.nombre.toLowerCase().includes(q) && perteneceAGrado(a.grado))
    .forEach((a, i) => {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `<b>${a.nombre}</b> (${a.padre || '-'}) - ${a.grado}<br><small>${a.comentarios || ''}</small>`;
      
      // Botones de acción (no disponibles para visitantes)
      if (!(usuarioActivo && ROLE_ALIASES.VISIT.includes(usuarioActivo.rol))) {
        const acciones = document.createElement('div');
        acciones.className = 'item-actions';
        
        const btnEditar = document.createElement('button');
        btnEditar.textContent = 'Editar';
        btnEditar.className = 'btn-edit';
        btnEditar.onclick = () => editarAlumno(i);
        acciones.appendChild(btnEditar);
        
        const btnEliminar = document.createElement('button');
        btnEliminar.textContent = 'Eliminar';
        btnEliminar.className = 'btn-delete';
        btnEliminar.onclick = () => eliminarAlumno(i);
        acciones.appendChild(btnEliminar);
        
        div.appendChild(acciones);
      }
      
      cont.appendChild(div);
    });
}

function editarAlumno(index) {
  if (usuarioActivo && ROLE_ALIASES.VISIT.includes(usuarioActivo.rol)) {
    mostrarNotificacion('❌ No tienes permisos para editar alumnos');
    return;
  }
  
  const alumno = alumnos[index];
  document.getElementById('nombreAlumno').value = alumno.nombre;
  document.getElementById('padreAlumno').value = alumno.padre || '';
  document.getElementById('comentariosAlumno').value = alumno.comentarios || '';
  
  editandoIndex = index;
  moduloEditando = 'alumnos';
  
  mostrarNotificacion('✏️ Editando alumno...');
}

function eliminarAlumno(index) {
  if (usuarioActivo && ROLE_ALIASES.VISIT.includes(usuarioActivo.rol)) {
    mostrarNotificacion('❌ No tienes permisos para eliminar alumnos');
    return;
  }
  
  const alumno = alumnos[index];
  if (confirm(`¿Estás seguro de eliminar al alumno "${alumno.nombre}"?`)) {
    alumnos.splice(index, 1);
    registrarAccion(`Eliminó alumno: ${alumno.nombre}`);
    guardarDatos();
    mostrarAlumnos();
    mostrarNotificacion('✅ Alumno eliminado correctamente');
  }
}

function guardarPadre(){
  if(usuarioActivo && ROLE_ALIASES.VISIT.includes(usuarioActivo.rol)) return mostrarNotificacion('Sin permiso para guardar');
  
  const nombre = document.getElementById('nombrePadre').value.trim();
  const telefono = document.getElementById('telefonoPadre').value.trim();
  const grupo = document.getElementById('grupoPadre').value;
  
  if(!nombre) return mostrarNotificacion('Completar nombre');
  
  if (editandoIndex !== -1 && moduloEditando === 'padres') {
    padres[editandoIndex] = { nombre, telefono, grupo };
    registrarAccion(`Editó padre: ${nombre}`);
    mostrarNotificacion('✅ Padre actualizado correctamente');
    editandoIndex = -1;
    moduloEditando = '';
  } else {
    padres.push({ nombre, telefono, grupo });
    registrarAccion(`Nuevo padre: ${nombre}`);
    mostrarNotificacion('✅ Padre agregado correctamente');
  }
  
  guardarDatos();
  mostrarPadres();
  limpiarFormularioPadre();
}

function limpiarFormularioPadre() {
  document.getElementById('nombrePadre').value = '';
  document.getElementById('telefonoPadre').value = '';
  document.getElementById('grupoPadre').value = '';
}

function mostrarPadres(){
  const cont = document.getElementById('listaPadres');
  const q = document.getElementById('buscarPadre').value?.toLowerCase() || '';
  cont.innerHTML = '';
  
  padres.filter(p => p.nombre.toLowerCase().includes(q) && perteneceAGrado(p.grupo))
    .forEach((p, i) => {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `<b>${p.nombre}</b> - ${p.telefono || '-'}<br><small>Grupo: ${p.grupo || '-'}</small>`;
      
      // Botones de acción (no disponibles para visitantes)
      if (!(usuarioActivo && ROLE_ALIASES.VISIT.includes(usuarioActivo.rol))) {
        const acciones = document.createElement('div');
        acciones.className = 'item-actions';
        
        const btnEditar = document.createElement('button');
        btnEditar.textContent = 'Editar';
        btnEditar.className = 'btn-edit';
        btnEditar.onclick = () => editarPadre(i);
        acciones.appendChild(btnEditar);
        
        const btnEliminar = document.createElement('button');
        btnEliminar.textContent = 'Eliminar';
        btnEliminar.className = 'btn-delete';
        btnEliminar.onclick = () => eliminarPadre(i);
        acciones.appendChild(btnEliminar);
        
        div.appendChild(acciones);
      }
      
      cont.appendChild(div);
    });
}

function editarPadre(index) {
  if (usuarioActivo && ROLE_ALIASES.VISIT.includes(usuarioActivo.rol)) {
    mostrarNotificacion('❌ No tienes permisos para editar padres');
    return;
  }
  
  const padre = padres[index];
  document.getElementById('nombrePadre').value = padre.nombre;
  document.getElementById('telefonoPadre').value = padre.telefono || '';
  document.getElementById('grupoPadre').value = padre.grupo || '';
  
  editandoIndex = index;
  moduloEditando = 'padres';
  
  mostrarNotificacion('✏️ Editando padre...');
}

function eliminarPadre(index) {
  if (usuarioActivo && ROLE_ALIASES.VISIT.includes(usuarioActivo.rol)) {
    mostrarNotificacion('❌ No tienes permisos para eliminar padres');
    return;
  }
  
  const padre = padres[index];
  if (confirm(`¿Estás seguro de eliminar al padre "${padre.nombre}"?`)) {
    padres.splice(index, 1);
    registrarAccion(`Eliminó padre: ${padre.nombre}`);
    guardarDatos();
    mostrarPadres();
    mostrarNotificacion('✅ Padre eliminado correctamente');
  }
}

function guardarGrupo(){
  if(!ROLE_ALIASES.ADMIN.includes(usuarioActivo.rol) && !ROLE_ALIASES.SUPER.includes(usuarioActivo.rol)) return mostrarNotificacion('Solo administrador');
  
  const nombre = document.getElementById('nombreGrupo').value.trim();
  const descripcion = document.getElementById('descripcionGrupo').value.trim();
  
  if(!nombre) return mostrarNotificacion('Completar nombre');
  
  if (editandoIndex !== -1 && moduloEditando === 'grupos') {
    grupos[editandoIndex] = { nombre, descripcion, grado: (usuarioActivo && usuarioActivo.grado) ? usuarioActivo.grado : 'Todos' };
    registrarAccion(`Editó grupo: ${nombre}`);
    mostrarNotificacion('✅ Grupo actualizado correctamente');
    editandoIndex = -1;
    moduloEditando = '';
  } else {
    const gradoAsignado = (usuarioActivo && usuarioActivo.grado) ? usuarioActivo.grado : 'Todos';
    grupos.push({ nombre, descripcion, grado: gradoAsignado });
    registrarAccion(`Nuevo grupo: ${nombre} (${gradoAsignado})`);
    mostrarNotificacion('✅ Grupo agregado correctamente');
  }
  
  guardarDatos();
  mostrarGrupos();
  document.getElementById('nombreGrupo').value = '';
  document.getElementById('descripcionGrupo').value = '';
}

function mostrarGrupos(){
  const cont = document.getElementById('listaGrupos');
  const q = document.getElementById('buscarGrupo').value?.toLowerCase() || '';
  cont.innerHTML = '';
  
  grupos.filter(g => (typeof g === 'object' ? g.nombre.toLowerCase().includes(q) : g.toLowerCase().includes(q)) )
    .filter(g => (usuarioActivo && (ROLE_ALIASES.SUPER.includes(usuarioActivo.rol))) ? true : ((typeof g === 'object') ? g.grado === usuarioActivo.grado : false))
    .forEach((g, i) => {
      const div = document.createElement('div');
      div.className = 'item';
      
      if (typeof g === 'object') {
        div.innerHTML = `<b>${g.nombre}</b><br><small>${g.descripcion || ''}</small>`;
        
        // Botones de acción (no disponibles para visitantes)
        if (!(usuarioActivo && ROLE_ALIASES.VISIT.includes(usuarioActivo.rol))) {
          const acciones = document.createElement('div');
          acciones.className = 'item-actions';
          
          const btnEditar = document.createElement('button');
          btnEditar.textContent = 'Editar';
          btnEditar.className = 'btn-edit';
          btnEditar.onclick = () => editarGrupo(i);
          acciones.appendChild(btnEditar);
          
          const btnEliminar = document.createElement('button');
          btnEliminar.textContent = 'Eliminar';
          btnEliminar.className = 'btn-delete';
          btnEliminar.onclick = () => eliminarGrupo(i);
          acciones.appendChild(btnEliminar);
          
          div.appendChild(acciones);
        }
      } else {
        div.innerHTML = `<b>${g}</b>`;
      }
      
      cont.appendChild(div);
    });
}

function editarGrupo(index) {
  if (usuarioActivo && ROLE_ALIASES.VISIT.includes(usuarioActivo.rol)) {
    mostrarNotificacion('❌ No tienes permisos para editar grupos');
    return;
  }
  
  const grupo = grupos[index];
  if (typeof grupo === 'object') {
    document.getElementById('nombreGrupo').value = grupo.nombre;
    document.getElementById('descripcionGrupo').value = grupo.descripcion || '';
    
    editandoIndex = index;
    moduloEditando = 'grupos';
    
    mostrarNotificacion('✏️ Editando grupo...');
  } else {
    mostrarNotificacion('❌ No se puede editar un grupo predefinido');
  }
}

function eliminarGrupo(index) {
  if (usuarioActivo && ROLE_ALIASES.VISIT.includes(usuarioActivo.rol)) {
    mostrarNotificacion('❌ No tienes permisos para eliminar grupos');
    return;
  }
  
  const grupo = grupos[index];
  if (typeof grupo === 'object') {
    if (confirm(`¿Estás seguro de eliminar el grupo "${grupo.nombre}"?`)) {
      grupos.splice(index, 1);
      registrarAccion(`Eliminó grupo: ${grupo.nombre}`);
      guardarDatos();
      mostrarGrupos();
      mostrarNotificacion('✅ Grupo eliminado correctamente');
    }
  } else {
    mostrarNotificacion('❌ No se puede eliminar un grupo predefinido');
  }
}

// ========== MÓDULO REUNIONES, PAGOS, USUARIOS etc. (se mantienen funciones previas) ==========

// cargar selects relacionados con padres/grupos
function cargarPadresSelect() {
  const sel = document.getElementById('padreAlumno');
  if (!sel) return;
  sel.innerHTML = '<option value="">Seleccionar padre/tutor</option>';
  padres.filter(p => perteneceAGrado(p.grupo))
    .forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.nombre;
      opt.textContent = p.nombre;
      sel.appendChild(opt);
    });
});
}

function cargarPadresPagoSelect() {
  const sel = document.getElementById('padrePago');
  if (!sel) return;
  sel.innerHTML = '<option value="">Seleccionar padre</option>';
  padres.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.nombre;
    opt.textContent = p.nombre;
    sel.appendChild(opt);
  });
}

function cargarPadresCheck() {
  const cont = document.getElementById('listaPadresCheck');
  if (!cont) return;
  cont.innerHTML = '';
  
  padres.filter(p => perteneceAGrado(p.grupo)).forEach(p => {
    const safeId = p.nombre.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_\-]/g, '');
    const div = document.createElement('div');
    div.innerHTML = `
      <input type="checkbox" id="padre_${safeId}" value="${p.nombre}">
      <label for="padre_${safeId}">${p.nombre} (${p.telefono || 'sin teléfono'})</label>
    `;
    cont.appendChild(div);
  });
}" value="${p.nombre}">
      <label for="padre_${p.nombre}">${p.nombre} (${p.telefono || 'sin teléfono'})</label>
    `;
    cont.appendChild(div);
  });
}

function cargarGrupoReunionSelect() {
  const sel = document.getElementById('grupoReunion');
  sel.innerHTML = '<option value="">Seleccionar grupo</option>';
  if (grupos && grupos.length>0) {
    grupos.forEach(g => {
      const groupName = typeof g === 'object' ? g.nombre : g;
      const groupGrade = typeof g === 'object' ? g.grado : null;
      if (!usuarioActivo) return;
      if (ROLE_ALIASES.SUPER.includes(usuarioActivo.rol) || groupGrade === usuarioActivo.grado) {
        const opt = document.createElement('option');
        opt.value = groupName;
        opt.textContent = groupName;
        sel.appendChild(opt);
      }
    });
  }
});
  }
}

function perteneceAGrado(valor) {
  if (!usuarioActivo) return false;
  if (ROLE_ALIASES.SUPER.includes(usuarioActivo.rol)) return true;
  if (!valor) return false;
  const gObj = grupos.find(g => (typeof g === 'object' ? g.nombre : g) === valor);
  if (gObj) return gObj.grado === usuarioActivo.grado;
  return valor === usuarioActivo.grado;
}

// ========== USUARIOS (mostrar, nuevo, editar, guardar, etc.) ==========
function mostrarUsuarios(){
  const cont = document.getElementById('listaUsuarios');
  const formulario = document.getElementById('formularioUsuario');
  const botonNuevoContainer = document.getElementById('botonNuevoUsuarioContainer');
  const q = document.getElementById('buscarUsuario').value?.toLowerCase() || '';
  
  // Configurar visibilidad según el rol
  const rolActivo = usuarioActivo ? usuarioActivo.rol : '';
  if (ROLE_ALIASES.SUPER.includes(rolActivo) || ROLE_ALIASES.ADMIN.includes(rolActivo)) {
    botonNuevoContainer.style.display = 'block';
  } else {
    botonNuevoContainer.style.display = 'none';
  }
  
  formulario.style.display = 'none';
  cont.innerHTML = '';
  
  const usuariosFiltrados = usuarios.filter(u => {
    const coincideBusqueda = u.user.toLowerCase().includes(q);
    if(!coincideBusqueda) return false;
    const rol = usuarioActivo ? usuarioActivo.rol : '';
    if (ROLE_ALIASES.SUPER.includes(rol)) return true;
    if (ROLE_ALIASES.ADMIN.includes(rol)) {
      return u.grado === usuarioActivo.grado && !ROLE_ALIASES.SUPER.includes(u.rol);
    }
    return false;
  });
  
  if (usuariosFiltrados.length === 0) {
    cont.innerHTML = '<div class="item">No hay usuarios para mostrar</div>';
    return;
  }
  
  usuariosFiltrados.forEach((u) => {
    const indexReal = usuarios.findIndex(user => user.user === u.user);
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `<b>${u.user}</b> (${u.rol}) - ${u.grado || '-'}`;
    
    const acciones = document.createElement('div');
    acciones.className = 'item-actions';
    
    if (ROLE_ALIASES.SUPER.includes(usuarioActivo.rol) || (ROLE_ALIASES.ADMIN.includes(usuarioActivo.rol) && !ROLE_ALIASES.SUPER.includes(u.rol))) {
      const btnEditar = document.createElement('button');
      btnEditar.textContent = 'Editar';
      btnEditar.className = 'btn-edit';
      btnEditar.onclick = () => editarUsuario(indexReal);
      acciones.appendChild(btnEditar);
    }
    
    if (ROLE_ALIASES.SUPER.includes(usuarioActivo.rol)) {
      const btnEliminar = document.createElement('button');
      btnEliminar.textContent = 'Eliminar';
      btnEliminar.className = 'btn-delete';
      btnEliminar.onclick = () => eliminarUsuario(indexReal);
      acciones.appendChild(btnEliminar);
    }
    
    if (acciones.children.length > 0) div.appendChild(acciones);
    cont.appendChild(div);
  });
}

function nuevoUsuario() {
  const formulario = document.getElementById('formularioUsuario');
  const selectRol = document.getElementById('rolUsuario');
  
  document.getElementById('nombreUsuario').value = '';
  document.getElementById('passUsuario').value = '';
  document.getElementById('telefonoUsuario').value = '591';
  
  selectRol.innerHTML = '';
  // Opciones según rol activo
  const rolActivo = usuarioActivo ? usuarioActivo.rol : '';
  if (ROLE_ALIASES.SUPER.includes(rolActivo)) {
    selectRol.innerHTML = `
      <option value="superusuario">superusuario</option>
      <option value="admin">admin</option>
      <option value="operador">operador</option>
      <option value="visitante">visitante</option>
    `;
  } else if (ROLE_ALIASES.ADMIN.includes(rolActivo)) {
    selectRol.innerHTML = `
      <option value="operador">operador</option>
      <option value="visitante">visitante</option>
    `;
  }
  
  const selectGrado = document.getElementById('gradoUsuario');
  if (usuarioActivo && usuarioActivo.grado !== 'Todos') {
    selectGrado.value = usuarioActivo.grado;
  } else {
    selectGrado.value = '';
  }
  
  formulario.style.display = 'block';
  editandoIndex = -1;
  moduloEditando = 'usuarios';
  document.getElementById('botonNuevoUsuarioContainer').style.display = 'none';
  document.getElementById('nombreUsuario').focus();
}

function cancelarEdicionUsuario() {
  document.getElementById('formularioUsuario').style.display = 'none';
  document.getElementById('botonNuevoUsuarioContainer').style.display = 'block';
  editandoIndex = -1;
  moduloEditando = '';
}

function editarUsuario(index) {
  const usuario = usuarios[index];
  const formulario = document.getElementById('formularioUsuario');
  const selectRol = document.getElementById('rolUsuario');
  
  selectRol.innerHTML = '';
  const rolActivo = usuarioActivo ? usuarioActivo.rol : '';
  if (ROLE_ALIASES.SUPER.includes(rolActivo)) {
    selectRol.innerHTML = `
      <option value="superusuario">superusuario</option>
      <option value="admin">admin</option>
      <option value="operador">operador</option>
      <option value="visitante">visitante</option>
    `;
  } else if (ROLE_ALIASES.ADMIN.includes(rolActivo)) {
    selectRol.innerHTML = `
      <option value="operador">operador</option>
      <option value="visitante">visitante</option>
    `;
  }
  
  document.getElementById('nombreUsuario').value = usuario.user;
  document.getElementById('passUsuario').value = usuario.pass;
  document.getElementById('telefonoUsuario').value = usuario.telefono || '591';
  document.getElementById('rolUsuario').value = usuario.rol;
  document.getElementById('gradoUsuario').value = usuario.grado || '';
  
  formulario.style.display = 'block';
  editandoIndex = index;
  moduloEditando = 'usuarios';
  document.getElementById('botonNuevoUsuarioContainer').style.display = 'none';
  
  mostrarNotificacion('✏️ Editando usuario...');
}

function guardarUsuario(){
  if(!usuarioActivo) return mostrarNotificacion('Inicia sesión');
  if(!ROLE_ALIASES.ADMIN.includes(usuarioActivo.rol) && !ROLE_ALIASES.SUPER.includes(usuarioActivo.rol)) return mostrarNotificacion('Solo administradores pueden gestionar usuarios');
  
  const user = document.getElementById('nombreUsuario').value.trim();
  const pass = document.getElementById('passUsuario').value.trim();
  const telefono = document.getElementById('telefonoUsuario').value.trim();
  let rol = document.getElementById('rolUsuario').value;
  let grado = document.getElementById('gradoUsuario').value;
  
  if(!user || !pass) return mostrarNotificacion('Completar usuario y contraseña');
  
  // Forzar restricciones: admin no puede crear superusuario; los usuarios creados por admin heredan grado
  if (ROLE_ALIASES.ADMIN.includes(usuarioActivo.rol)) {
    if (rol === 'superusuario') return mostrarNotificacion('❌ No tienes permisos para crear superusuario');
    grado = usuarioActivo.grado || grado;
  }
  
  if (editandoIndex !== -1 && moduloEditando === 'usuarios') {
    const usuarioOriginal = usuarios[editandoIndex];
    if (ROLE_ALIASES.ADMIN.includes(usuarioActivo.rol) && ROLE_ALIASES.SUPER.includes(usuarioOriginal.rol)) {
      return mostrarNotificacion('❌ No tienes permisos para editar este usuario');
    }
    usuarios[editandoIndex] = { user, pass, telefono, rol, grado };
    registrarAccion(`Editó usuario: ${user} (${rol})`);
    mostrarNotificacion('✅ Usuario actualizado correctamente');
  } else {
    const exists = usuarios.find(u => u.user === user);
    if (exists) return mostrarNotificacion('❌ El usuario ya existe');
    usuarios.push({ user, pass, telefono, rol, grado });
    registrarAccion(`Nuevo usuario: ${user} (${rol})`);
    mostrarNotificacion('✅ Usuario agregado correctamente');
  }
  
  guardarDatos();
  mostrarUsuarios();
  cancelarEdicionUsuario();
}

function eliminarUsuario(index) {
  if(!usuarioActivo) return mostrarNotificacion('Inicia sesión');
  if (!ROLE_ALIASES.SUPER.includes(usuarioActivo.rol)) {
    mostrarNotificacion('❌ Solo el superusuario puede eliminar usuarios');
    return;
  }
  const usuario = usuarios[index];
  if (usuario.user === usuarioActivo.user) {
    mostrarNotificacion('❌ No puedes eliminar tu propio usuario');
    return;
  }
  if (confirm(`¿Estás seguro de eliminar al usuario "${usuario.user}"?`)) {
    usuarios.splice(index, 1);
    registrarAccion(`Eliminó usuario: ${usuario.user}`);
    guardarDatos();
    mostrarUsuarios();
    mostrarNotificacion('✅ Usuario eliminado correctamente');
  }
}

// ========== CARGA INICIAL ==========
window.onload = function(){
  // Cargar selects de grupoPadre (solo grupos existentes)
  document.querySelectorAll('#grupoPadre').forEach(sel=>{
    sel.innerHTML = '<option value="">Seleccionar grupo</option>';
    if (grupos && grupos.length>0) {
      grupos.forEach(g=>{
        const opt = document.createElement('option');
        opt.value = typeof g === 'object' ? g.nombre : g;
        opt.textContent = typeof g === 'object' ? g.nombre : g;
        sel.appendChild(opt);
      });
    }
  });

  // Función para actualizar select de grados (se obtienen de usuarios y grupos)
  function actualizarGradosSelect() {
    const sel = document.getElementById('gradoUsuario');
    if (!sel) return;
    const set = new Set();
    usuarios.forEach(u => { if (u.grado) set.add(u.grado); });
    grupos.forEach(g => { if (typeof g === 'object' && g.grado) set.add(g.grado); });
    if (usuarioActivo && usuarioActivo.grado) set.add(usuarioActivo.grado);
    const grados = Array.from(set).filter(x=>x).sort();
    sel.innerHTML = '<option value="">Seleccionar grado</option>';
    grados.forEach(g => {
      const opt = document.createElement('option');
      opt.value = g;
      opt.textContent = g;
      sel.appendChild(opt);
    });
    if (usuarioActivo && usuarioActivo.grado && !ROLE_ALIASES.SUPER.includes(usuarioActivo.rol)) {
      sel.value = usuarioActivo.grado;
    }
  }

  actualizarGradosSelect();

  // Si hay usuario activo, restaurar sesión visual
  usuarioActivo = JSON.parse(localStorage.getItem('usuarioActivo') || 'null');
  if (usuarioActivo) {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainHeader').style.display = 'block';
    document.getElementById('menu').style.display = 'flex';
    configurarVisibilidadPorRol();
    renderMenuHeader();
    mostrarNotificacion(`Sesión activa: ${usuarioActivo.user}`);
  } else {
    // mostrar login original
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('mainHeader').style.display = 'none';
    document.getElementById('menu').style.display = 'none';
  }

  // Enter en login
  document.addEventListener('keydown', e => {
    if (e.key === 'Enter' && document.getElementById('loginScreen').style.display !== 'none') {
      login();
    }
  });
};

// Hacer que botón 'atrás' del sistema actúe como volver
window.addEventListener('popstate', e => { if (typeof volver === 'function') volver(); });
</script>

</body>
</html>
