<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Control de asistencias y pagos - UE Bolivia Venezuela</title>
<style>
  :root{
    --bg:#f7f7f7; --card:#fff; --accent:#2e7d32; --btn:#4CAF50; --danger:#d9534f;
  }
  body{
    font-family:Arial,Helvetica,sans-serif;
    background:var(--bg);
    margin:0;
    color:#222;
    -webkit-font-smoothing:antialiased;
  }

  /* PANTALLA DE LOGIN */
  #login-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    background: linear-gradient(135deg, #2e7d32, #4CAF50);
  }
  
  .login-container {
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    width: 90%;
    max-width: 400px;
    text-align: center;
  }
  
  .login-title {
    color: #2e7d32;
    margin-bottom: 10px;
    font-size: 24px;
  }
  
  .login-subtitle {
    color: #666;
    margin-bottom: 25px;
  }
  
  .login-input {
    width: 100%;
    padding: 12px;
    margin: 10px 0;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 16px;
    box-sizing: border-box;
  }
  
  .login-btn {
    width: 100%;
    padding: 12px;
    background: #2e7d32;
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 16px;
    cursor: pointer;
    margin-top: 10px;
    transition: background 0.3s;
  }
  
  .login-btn:hover {
    background: #1b5e20;
  }
  
  .user-info {
    font-size: 14px;
    color: #666;
    margin-top: 20px;
    padding: 10px;
    background: #f9f9f9;
    border-radius: 5px;
  }

  /* CONTENIDO PRINCIPAL (oculto inicialmente) */
  #main-app {
    display: none;
  }

  header{
    text-align:center;
    padding:18px 10px 6px;
  }
  h1{
    margin:0;
    font-size:20px;
    line-height:1.2;
    color:#333;
  }
  h1 .subtitulo{ 
    display:block; 
    font-size:20px; 
    color:#333; 
    margin-top:6px; 
  }

  /* Menu - buttons single column centered */
  #menu{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:10px;
    padding:18px;
  }
  #menu button{
    width: 88%;
    max-width: 300px;
    padding:10px 12px;
    font-size:16px;
    border-radius:10px;
    border:0;
    background:var(--btn);
    color:white;
    cursor:pointer;
    transition:transform .08s, background .12s;
  }
  #menu button:hover{ transform:translateY(-2px); background:#45a049; }

  /* Modules */
  .modulo{ display:none; padding:16px; max-width:820px; margin:0 auto; box-sizing:border-box; }
  .modulo.active{ display:block; }

  .row{ display:flex; gap:12px; flex-wrap:wrap; justify-content:center; align-items:center; margin-bottom:8px; }

  .formulario{
    background:var(--card);
    padding:14px;
    border-radius:10px;
    box-shadow:0 1px 6px rgba(0,0,0,.06);
  }
  .formulario input, .formulario select, .formulario textarea {
    width:84%;
    max-width:480px;
    padding:9px;
    margin:8px auto;
    font-size:15px;
    border-radius:8px;
    border:1px solid #ccc;
    display:block;
  }
  .form-btn {
    display:inline-block;
    background:var(--btn);
    color:white;
    border:0;
    padding:9px 12px;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
    margin-top:6px;
    transition: all 0.3s ease;
  }
  .form-btn:disabled{ opacity:.7; cursor:not-allowed; }
  .form-btn.saving {
    background: #666;
    transform: scale(0.98);
  }

  .mensaje-boton {
    display:inline-block;
    font-weight:700;
    color:var(--accent);
    margin-left:10px;
    font-size:14px;
  }

  input[type="text"].small, input[type="date"].small { width:180px; display:inline-block; margin-right:8px; }

  .lista {
    margin-top:14px;
    max-width:760px;
    margin-left:auto;
    margin-right:auto;
    text-align:left;
  }
  .item{
    background:#fff;
    padding:10px;
    border-radius:8px;
    box-shadow:0 1px 4px rgba(0,0,0,.06);
    margin-bottom:10px;
    cursor:pointer;
  }
  .item strong{ color:var(--btn); }
  .detalles{ display:none; margin-top:8px; border-top:1px solid #eee; padding-top:8px; font-size:14px; color:#333; }
  .acciones button{ margin-right:8px; padding:6px 8px; border-radius:6px; border:0; cursor:pointer; font-weight:600; }
  .acciones .edit{ background:#f0ad4e; color:#000; }
  .acciones .del{ background:var(--danger); color:white; }

  /* ESTILOS COMPLETAMENTE CORREGIDOS PARA LA LISTA DE PADRES */
  #listaPadresCheck {
    margin: 8px 0 0 0;
    padding: 0;
    text-align: left;
    width: 100%;
    display: block;
  }
  .check-item {
    padding: 6px 0;
    display: flex;
    align-items: center;
    margin: 0;
    width: 100%;
    justify-content: flex-start;
  }
  .check-item input {
    margin: 0 10px 0 0;
    width: auto;
    transform: scale(1.2);
    flex-shrink: 0;
  }
  .check-item label {
    cursor: pointer;
    font-size: 15px;
    margin: 0;
    display: block;
  }

  .volver {
    display:inline-block;
    margin-top:12px;
    background:#666;
    color:#fff;
    padding:8px 12px;
    border-radius:8px;
    border:0;
    cursor:pointer;
  }

  /* search inputs */
  .search {
    width:84%;
    max-width:480px;
    padding:8px;
    border-radius:8px;
    border:1px solid #ccc;
    display:block;
    margin:10px auto 6px;
  }

  /* Filtro de grupos en reuniones */
  .filtro-grupo {
    width: 84%;
    max-width: 480px;
    padding: 8px;
    border-radius: 8px;
    border: 1px solid #ccc;
    display: block;
    margin: 10px auto 6px;
    font-size: 15px;
  }

  /* Bot√≥n de exportar */
  .btn-exportar {
    display: inline-block;
    background: #2196F3;
    color: white;
    border: 0;
    padding: 9px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    margin-top: 6px;
    transition: all 0.3s ease;
  }
  .btn-exportar:hover {
    background: #0b7dda;
  }

  /* Bot√≥n de cerrar sesi√≥n */
  .logout-btn {
    position: fixed;
    top: 10px;
    right: 10px;
    background: #666;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    z-index: 1000;
  }

  /* Elementos deshabilitados para roles espec√≠ficos */
  .admin-only {
    display: none;
  }
  
  .operador-only {
    display: none;
  }
  
  .visitante-only {
    display: none;
  }

  /* Estilos para la bit√°cora */
  .bitacora-item {
    background: #fff;
    padding: 12px;
    border-radius: 8px;
    box-shadow: 0 1px 4px rgba(0,0,0,.06);
    margin-bottom: 10px;
    border-left: 4px solid #4CAF50;
  }
  
  .bitacora-tipo {
    font-weight: bold;
    color: #2e7d32;
    margin-right: 8px;
  }
  
  .bitacora-fecha {
    color: #666;
    font-size: 12px;
  }
  
  .bitacora-detalles {
    margin-top: 5px;
    font-size: 14px;
    color: #333;
  }

  /* Estilos para usuarios */
  .badge-admin {
    background: #d9534f;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    margin-left: 8px;
  }
  
  .badge-operador {
    background: #f0ad4e;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    margin-left: 8px;
  }
  
  .badge-visitante {
    background: #5bc0de;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    margin-left: 8px;
  }

  /* responsive tweaks */
  @media (max-width:520px){
    #menu button{ width:92%; font-size:15px; }
    .formulario input, .formulario select, .formulario textarea { width:94%; }
  }
</style>
</head>
<body>

<!-- PANTALLA DE LOGIN -->
<div id="login-screen">
  <div class="login-container">
    <h2 class="login-title">Control de Asistencias y Pagos</h2>
    <p class="login-subtitle">UE Bolivia Venezuela</p>
    
    <input type="text" id="username" class="login-input" placeholder="Usuario">
    <input type="password" id="password" class="login-input" placeholder="Contrase√±a">
    
    <button id="login-btn" class="login-btn" onclick="login()">Ingresar</button>
    
    <div class="user-info">
      <p><strong>Usuario inicial:</strong></p>
      <p>Usuario: Visitante, Contrase√±a: 123</p>
      <p style="margin-top: 10px; font-size: 12px; color: #888;">
        Despu√©s de ingresar, solo podr√° ver pero no podras modificar datos
      </p>
    </div>
  </div>
</div>

<!-- APLICACI√ìN PRINCIPAL -->
<div id="main-app">
  <button class="logout-btn" onclick="logout()">Cerrar Sesi√≥n</button>

  <header>
    <h1>Control de asistencias y pagos<br><span class="subtitulo">UE Bolivia Venezuela</span></h1>
    <p id="user-info" style="font-size:14px; color:#666; margin-top:5px;"></p>
  </header>

  <!-- MENU -->
  <div id="menu" aria-label="Men√∫ principal">
    <button onclick="abrirModulo('alumnos')">Alumnos</button>
    <button onclick="abrirModulo('padres')">Padres</button>
    <button onclick="abrirModulo('grupos')">Grupos</button>
    <button onclick="abrirModulo('reuniones')">Reuniones</button>
    <button onclick="abrirModulo('pagos')">Pagos</button>
    <button onclick="abrirModulo('usuarios')" class="admin-only">Usuarios</button>
    <button onclick="abrirModulo('bitacora')" class="admin-only">Bit√°cora</button>
    <button class="btn-exportar admin-only operador-only" onclick="exportarDatos()">Exportar Datos a Excel</button>
  </div>

  <!-- ===== ALUMNOS ===== -->
  <section id="alumnos" class="modulo" aria-hidden="true">
    <h2>Alumnos</h2>
    <div class="formulario" role="group" aria-label="Formulario alumnos">
      <input id="nombreAlumno" type="text" placeholder="Nombre completo">
      <select id="padreAlumno"><option value="">Seleccionar padre/tutor</option></select>
      <textarea id="comentariosAlumno" placeholder="Comentarios"></textarea>

      <div class="row" style="justify-content:center;">
        <button id="btnGuardarAlumno" class="form-btn admin-only operador-only" onclick="guardarAlumno(this)">Guardar</button>
        <span id="saveMsgAlumno" class="mensaje-boton" aria-live="polite" style="display:none"></span>
      </div>
    </div>

    <input id="buscarAlumno" class="search" type="text" placeholder="Buscar alumno (por nombre parcial)">
    <div id="listaAlumnos" class="lista" aria-live="polite"></div>
    <div style="text-align:center">
      <button class="btn-exportar admin-only operador-only" onclick="exportarAlumnosExcel()">Exportar Alumnos a Excel</button>
      <button class="volver" onclick="volverMenu()">Volver</button>
    </div>
  </section>

  <!-- ===== PADRES ===== -->
  <section id="padres" class="modulo" aria-hidden="true">
    <h2>Padres / Tutores</h2>
    <div class="formulario" role="group">
      <input id="nombrePadre" type="text" placeholder="Nombre completo">
      <input id="telefonoPadre" type="text" placeholder="Tel√©fono">
      <select id="grupoPadre"><option value="">Seleccionar grupo</option></select>
      <div class="row" style="justify-content:center;">
        <button id="btnGuardarPadre" class="form-btn admin-only operador-only" onclick="guardarPadre(this)">Guardar</button>
        <span id="saveMsgPadre" class="mensaje-boton" style="display:none"></span>
      </div>
    </div>

    <input id="buscarPadre" class="search" type="text" placeholder="Buscar padre (por nombre)">
    <div id="listaPadres" class="lista" aria-live="polite"></div>
    <div style="text-align:center">
      <button class="btn-exportar admin-only operador-only" onclick="exportarPadresExcel()">Exportar Padres a Excel</button>
      <button class="volver" onclick="volverMenu()">Volver</button>
    </div>
  </section>

  <!-- ===== GRUPOS ===== -->
  <section id="grupos" class="modulo" aria-hidden="true">
    <h2>Grupos</h2>
    <div class="formulario" role="group">
      <input id="nombreGrupo" type="text" placeholder="Nombre del grupo">
      <textarea id="descripcionGrupo" placeholder="Descripci√≥n (opcional)"></textarea>
      <div class="row" style="justify-content:center;">
        <button id="btnGuardarGrupo" class="form-btn admin-only operador-only" onclick="guardarGrupo(this)">Guardar</button>
        <span id="saveMsgGrupo" class="mensaje-boton" style="display:none"></span>
      </div>
    </div>

    <input id="buscarGrupo" class="search" type="text" placeholder="Buscar grupo">
    <div id="listaGrupos" class="lista" aria-live="polite"></div>
    <div style="text-align:center">
      <button class="btn-exportar admin-only operador-only" onclick="exportarGruposExcel()">Exportar Grupos a Excel</button>
      <button class="volver" onclick="volverMenu()">Volver</button>
    </div>
  </section>

  <!-- ===== REUNIONES ===== -->
  <section id="reuniones" class="modulo" aria-hidden="true">
    <h2>Reuniones</h2>
    <div class="formulario" role="group" style="text-align: left;">
      <input id="tituloReunion" type="text" placeholder="T√≠tulo de la reuni√≥n">
      <input id="fechaReunion" type="date">
      <input id="horaReunion" type="time">
      <textarea id="observacionesReunion" placeholder="Observaciones"></textarea>

      <h4 style="margin:8px 0 6px; text-align:left;">Seleccionar padres presentes:</h4>
      
      <!-- Filtro por grupos -->
      <select id="filtroGrupoReunion" class="filtro-grupo">
        <option value="">Todos los grupos</option>
      </select>
      
      <div id="listaPadresCheck" aria-label="Lista de padres con checkbox"></div>

      <div class="row" style="justify-content:center;">
        <button id="btnGuardarReunion" class="form-btn admin-only operador-only" onclick="guardarReunion(this)">Guardar reuni√≥n</button>
        <span id="saveMsgReunion" class="mensaje-boton" style="display:none"></span>
      </div>
    </div>

    <input id="buscarReunion" class="search" type="text" placeholder="Buscar reuni√≥n (por t√≠tulo)">
    <div id="listaReuniones" class="lista" aria-live="polite"></div>
    <div style="text-align:center">
      <button class="btn-exportar admin-only operador-only" onclick="exportarReunionesExcel()">Exportar Reuniones a Excel</button>
      <button class="volver" onclick="volverMenu()">Volver</button>
    </div>
  </section>

  <!-- ===== PAGOS ===== -->
  <section id="pagos" class="modulo" aria-hidden="true">
    <h2>Pagos</h2>
    <div class="formulario" role="group">
      <select id="alumnoPago"><option value="">Seleccionar alumno</option></select>
      <input id="montoPago" type="number" placeholder="Monto (Bs)" min="0" step="0.01">
      <input id="fechaPago" type="date">
      <input id="conceptoPago" type="text" placeholder="Concepto / detalle">
      <div class="row" style="justify-content:center;">
        <button id="btnGuardarPago" class="form-btn admin-only operador-only" onclick="guardarPago(this)">Guardar pago</button>
        <span id="saveMsgPago" class="mensaje-boton" style="display:none"></span>
      </div>
    </div>

    <input id="buscarPago" class="search" type="text" placeholder="Buscar pagos (por alumno)">
    <div id="listaPagos" class="lista" aria-live="polite"></div>
    <div style="text-align:center">
      <button class="btn-exportar admin-only operador-only" onclick="exportarPagosExcel()">Exportar Pagos a Excel</button>
      <button class="volver" onclick="volverMenu()">Volver</button>
    </div>
  </section>

  <!-- ===== USUARIOS ===== -->
  <section id="usuarios" class="modulo" aria-hidden="true">
    <h2>Gesti√≥n de Usuarios</h2>
    <div class="formulario" role="group">
      <input id="nombreUsuario" type="text" placeholder="Nombre de usuario">
      <input id="passwordUsuario" type="password" placeholder="Contrase√±a">
      <select id="tipoUsuario">
        <option value="admin">Administrador</option>
        <option value="operador">Operador</option>
        <option value="visitante">Visitante</option>
      </select>
      <div class="row" style="justify-content:center;">
        <button id="btnGuardarUsuario" class="form-btn admin-only" onclick="guardarUsuario(this)">Guardar Usuario</button>
        <span id="saveMsgUsuario" class="mensaje-boton" style="display:none"></span>
      </div>
    </div>

    <input id="buscarUsuario" class="search" type="text" placeholder="Buscar usuario">
    <div id="listaUsuarios" class="lista" aria-live="polite"></div>
    <div style="text-align:center">
      <button class="volver" onclick="volverMenu()">Volver</button>
    </div>
  </section>

  <!-- ===== BIT√ÅCORA ===== -->
  <section id="bitacora" class="modulo" aria-hidden="true">
    <h2>Bit√°cora del Sistema</h2>
    
    <div class="formulario" role="group">
      <div class="row" style="justify-content:center; gap: 10px;">
        <button class="form-btn" onclick="filtrarBitacora('todos')">Todos</button>
        <button class="form-btn" onclick="filtrarBitacora('login')">Ingresos</button>
        <button class="form-btn" onclick="filtrarBitacora('seccion')">Secciones</button>
        <button class="form-btn" onclick="filtrarBitacora('accion')">Acciones</button>
      </div>
      <div class="row" style="justify-content:center;">
        <button class="form-btn admin-only" onclick="limpiarBitacora()">Limpiar Bit√°cora</button>
        <button class="btn-exportar admin-only" onclick="exportarBitacoraExcel()">Exportar Bit√°cora</button>
      </div>
    </div>

    <div id="listaBitacora" class="lista" aria-live="polite"></div>
    <div style="text-align:center">
      <button class="volver" onclick="volverMenu()">Volver</button>
    </div>
  </section>
</div>

<script>
/* -----------------------------------------
  SISTEMA DE GESTI√ìN DE USUARIOS
----------------------------------------- */
let currentUser = null;

// Inicializar usuarios si no existen - CORREGIDO
function inicializarUsuarios() {
  let usuarios = JSON.parse(localStorage.getItem('usuarios'));
  
  // Si no hay usuarios o el array est√° vac√≠o, crear el usuario admin por defecto
  if (!usuarios || usuarios.length === 0) {
    console.log("Creando usuario admin por defecto...");
    usuarios = [
      {
        id: 1,
        username: 'admin',
        password: 'admin123',
        tipo: 'admin',
        fechaCreacion: new Date().toLocaleString('es-ES'),
        activo: true
      }
    ];
    localStorage.setItem('usuarios', JSON.stringify(usuarios));
    console.log("Usuario admin creado:", usuarios[0]);
  } else {
    console.log("Usuarios existentes:", usuarios);
  }
  
  return usuarios;
}

function login() {
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;

  if (!username || !password) {
    alert('Por favor complete usuario y contrase√±a');
    return;
  }

  // Asegurar que los usuarios est√©n inicializados
  inicializarUsuarios();
  
  const usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');
  console.log("Buscando usuario:", username, "en:", usuarios);
  
  const usuario = usuarios.find(u => u.username === username && u.password === password && u.activo);

  if (usuario) {
    currentUser = usuario;

    // Registrar evento de login en la bit√°cora
    registrarBitacora('login', 'Sistema', `Usuario ${username} ingres√≥ al sistema`);

    // Mostrar aplicaci√≥n principal
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('main-app').style.display = 'block';
    
    // Actualizar informaci√≥n del usuario
    document.getElementById('user-info').textContent = 
      `Usuario: ${username} (${obtenerNombreTipoUsuario(usuario.tipo)})`;
    
    // Configurar permisos seg√∫n tipo de usuario
    configurarPermisosPorRol(usuario.tipo);

    // Inicializar la aplicaci√≥n
    initApp();
  } else {
    alert('Usuario o contrase√±a incorrectos');
    console.log("Usuario no encontrado o contrase√±a incorrecta");
  }
}

function obtenerNombreTipoUsuario(tipo) {
  switch(tipo) {
    case 'admin': return 'Administrador';
    case 'operador': return 'Operador';
    case 'visitante': return 'Visitante';
    default: return 'Usuario';
  }
}

function configurarPermisosPorRol(tipoUsuario) {
  // Ocultar todos los elementos espec√≠ficos por rol primero
  document.querySelectorAll('.admin-only, .operador-only, .visitante-only').forEach(el => {
    el.style.display = 'none';
  });
  
  // Mostrar elementos seg√∫n el rol
  switch(tipoUsuario) {
    case 'admin':
      document.querySelectorAll('.admin-only').forEach(el => {
        el.style.display = 'inline-block';
      });
      break;
    case 'operador':
      document.querySelectorAll('.operador-only').forEach(el => {
        el.style.display = 'inline-block';
      });
      break;
    case 'visitante':
      document.querySelectorAll('.visitante-only').forEach(el => {
        el.style.display = 'inline-block';
      });
      break;
  }
  
  // Elementos que deben verse para m√∫ltiples roles
  if (tipoUsuario === 'admin' || tipoUsuario === 'operador') {
    document.querySelectorAll('.admin-only, .operador-only').forEach(el => {
      el.style.display = 'inline-block';
    });
  }
}

function logout() {
  // Registrar evento de logout en la bit√°cora
  if (currentUser) {
    registrarBitacora('login', 'Sistema', `Usuario ${currentUser.username} cerr√≥ sesi√≥n`);
  }
  
  currentUser = null;
  document.getElementById('main-app').style.display = 'none';
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('username').value = '';
  document.getElementById('password').value = '';
}

// Permitir login con Enter
document.getElementById('password').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    login();
  }
});

/* -----------------------------------------
  GESTI√ìN DE USUARIOS
----------------------------------------- */
let editIndexUsuario = null;

function guardarUsuario(btn) {
  // Verificar permisos - solo admin puede gestionar usuarios
  if (currentUser.tipo !== 'admin') {
    alert('No tiene permisos para realizar esta acci√≥n');
    return;
  }

  const nombre = document.getElementById('nombreUsuario').value.trim();
  const password = document.getElementById('passwordUsuario').value;
  const tipo = document.getElementById('tipoUsuario').value;

  if (!nombre) {
    alert('El nombre de usuario es obligatorio');
    return;
  }

  if (!password && editIndexUsuario === null) {
    alert('La contrase√±a es obligatoria para nuevos usuarios');
    return;
  }

  let usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');

  // Verificar si el usuario ya existe (excepto en edici√≥n)
  if (editIndexUsuario === null) {
    const usuarioExistente = usuarios.find(u => u.username === nombre);
    if (usuarioExistente) {
      alert('Ya existe un usuario con ese nombre');
      return;
    }
  }

  if (editIndexUsuario !== null) {
    // Editar usuario existente
    const usuario = usuarios[editIndexUsuario];
    
    // Si el usuario que se edita es el mismo que est√° logueado y se cambia a un rol con menos permisos
    if (usuario.id === currentUser.id && (tipo === 'operador' || tipo === 'visitante')) {
      if (!confirm('Si cambia su propio usuario a un rol con menos permisos, podr√≠a perder acceso a funciones. ¬øContinuar?')) {
        return;
      }
    }
    
    usuarios[editIndexUsuario] = {
      ...usuario,
      username: nombre,
      tipo: tipo,
      fechaModificacion: new Date().toLocaleString('es-ES')
    };
    
    // Actualizar contrase√±a solo si se proporcion√≥ una nueva
    if (password) {
      usuarios[editIndexUsuario].password = password;
    }
    
    editIndexUsuario = null;
    registrarBitacora('accion', 'Usuarios', `Edit√≥ usuario: ${nombre} (${tipo})`);
  } else {
    // Crear nuevo usuario
    const nuevoUsuario = {
      id: Date.now(),
      username: nombre,
      password: password,
      tipo: tipo,
      fechaCreacion: new Date().toLocaleString('es-ES'),
      activo: true
    };
    
    usuarios.push(nuevoUsuario);
    registrarBitacora('accion', 'Usuarios', `Cre√≥ nuevo usuario: ${nombre} (${tipo})`);
  }

  localStorage.setItem('usuarios', JSON.stringify(usuarios));
  tempSaved(btn, '‚úÖ Usuario guardado');
  limpiarUsuario();
  mostrarUsuarios();
}

function limpiarUsuario() {
  document.getElementById('nombreUsuario').value = '';
  document.getElementById('passwordUsuario').value = '';
  document.getElementById('tipoUsuario').value = 'admin';
  editIndexUsuario = null;
}

function mostrarUsuarios() {
  const cont = document.getElementById('listaUsuarios');
  cont.innerHTML = '';
  
  const q = document.getElementById('buscarUsuario').value.trim().toLowerCase();
  let usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');
  
  const lista = usuarios.filter(u => !q || u.username.toLowerCase().includes(q));
  
  if (lista.length === 0) {
    cont.innerHTML = '<div class="item">No hay usuarios registrados.</div>';
    return;
  }
  
  lista.forEach((usuario, i) => {
    const idx = usuarios.indexOf(usuario);
    const div = document.createElement('div');
    div.className = 'item';
    
    let badge = '';
    switch(usuario.tipo) {
      case 'admin':
        badge = '<span class="badge-admin">Admin</span>';
        break;
      case 'operador':
        badge = '<span class="badge-operador">Operador</span>';
        break;
      case 'visitante':
        badge = '<span class="badge-visitante">Visitante</span>';
        break;
    }
    
    const estado = usuario.activo ? 
      '<span style="color: green;">‚óè Activo</span>' : 
      '<span style="color: red;">‚óè Inactivo</span>';
    
    div.innerHTML = `
      <strong>${escapeHtml(usuario.username)}</strong> ${badge} ${estado}
      <div class="detalles">
        <p><b>Fecha creaci√≥n:</b> ${escapeHtml(usuario.fechaCreacion)}</p>
        ${usuario.fechaModificacion ? `<p><b>√öltima modificaci√≥n:</b> ${escapeHtml(usuario.fechaModificacion)}</p>` : ''}
        <div class="acciones">
          <button class="edit admin-only" onclick="editarUsuario(${idx})">Editar</button>
          ${usuario.id !== currentUser.id ? `<button class="del admin-only" onclick="eliminarUsuario(${idx})">${usuario.activo ? 'Desactivar' : 'Activar'}</button>` : ''}
          ${usuario.id !== currentUser.id ? `<button class="del admin-only" onclick="eliminarUsuarioPermanente(${idx})" style="background: #dc3545;">Eliminar</button>` : ''}
        </div>
      </div>
    `;
    
    div.onclick = (e) => {
      if (e.target.tagName.toLowerCase() === 'button') return;
      const det = div.querySelector('.detalles');
      det.style.display = det.style.display === 'block' ? 'none' : 'block';
    };
    
    cont.appendChild(div);
  });
  
  // Aplicar permisos de visualizaci√≥n
  configurarPermisosPorRol(currentUser.tipo);
}

function editarUsuario(i) {
  // Verificar permisos
  if (currentUser.tipo !== 'admin') {
    alert('No tiene permisos para realizar esta acci√≥n');
    return;
  }

  const usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');
  const usuario = usuarios[i];
  
  document.getElementById('nombreUsuario').value = usuario.username;
  document.getElementById('passwordUsuario').value = ''; // No mostrar contrase√±a actual
  document.getElementById('tipoUsuario').value = usuario.tipo;
  editIndexUsuario = i;
  
  abrirModulo('usuarios');
}

function eliminarUsuario(i) {
  // Verificar permisos
  if (currentUser.tipo !== 'admin') {
    alert('No tiene permisos para realizar esta acci√≥n');
    return;
  }

  const usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');
  const usuario = usuarios[i];
  
  if (usuario.id === currentUser.id) {
    alert('No puede desactivar su propio usuario');
    return;
  }
  
  const accion = usuario.activo ? 'desactivar' : 'activar';
  
  if (confirm(`¬øEst√° seguro de ${accion} al usuario: ${usuario.username}?`)) {
    usuarios[i].activo = !usuarios[i].activo;
    usuarios[i].fechaModificacion = new Date().toLocaleString('es-ES');
    
    localStorage.setItem('usuarios', JSON.stringify(usuarios));
    mostrarUsuarios();
    
    registrarBitacora('accion', 'Usuarios', 
      `${usuario.activo ? 'Activ√≥' : 'Desactiv√≥'} usuario: ${usuario.username}`);
  }
}

function eliminarUsuarioPermanente(i) {
  // Verificar permisos
  if (currentUser.tipo !== 'admin') {
    alert('No tiene permisos para realizar esta acci√≥n');
    return;
  }

  const usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');
  const usuario = usuarios[i];
  
  if (usuario.id === currentUser.id) {
    alert('No puede eliminar su propio usuario');
    return;
  }
  
  if (confirm(`¬øEst√° seguro de ELIMINAR PERMANENTEMENTE al usuario: ${usuario.username}? Esta acci√≥n no se puede deshacer.`)) {
    usuarios.splice(i, 1);
    localStorage.setItem('usuarios', JSON.stringify(usuarios));
    mostrarUsuarios();
    
    registrarBitacora('accion', 'Usuarios', `Elimin√≥ permanentemente usuario: ${usuario.username}`);
  }
}

document.getElementById('buscarUsuario').addEventListener('input', mostrarUsuarios);

/* -----------------------------------------
  SISTEMA DE BIT√ÅCORA
----------------------------------------- */
function registrarBitacora(tipo, modulo, detalles) {
  if (!currentUser) return;

  const evento = {
    id: Date.now(),
    fecha: new Date().toLocaleString('es-ES'),
    usuario: currentUser.username,
    tipo: tipo, // 'login', 'seccion', 'accion'
    modulo: modulo,
    detalles: detalles
  };

  // Obtener bit√°cora actual o inicializar
  let bitacora = JSON.parse(localStorage.getItem('bitacora') || '[]');
  bitacora.unshift(evento); // Agregar al principio para mostrar los m√°s recientes primero
  
  // Mantener solo los √∫ltimos 1000 eventos para no saturar localStorage
  if (bitacora.length > 1000) {
    bitacora = bitacora.slice(0, 1000);
  }
  
  localStorage.setItem('bitacora', JSON.stringify(bitacora));
}

function mostrarBitacora(filtro = 'todos') {
  const cont = document.getElementById('listaBitacora');
  cont.innerHTML = '';
  
  let bitacora = JSON.parse(localStorage.getItem('bitacora') || '[]');
  
  // Aplicar filtro si es necesario
  if (filtro !== 'todos') {
    bitacora = bitacora.filter(evento => evento.tipo === filtro);
  }
  
  if (bitacora.length === 0) {
    cont.innerHTML = '<div class="item">No hay eventos en la bit√°cora.</div>';
    return;
  }
  
  bitacora.forEach(evento => {
    const div = document.createElement('div');
    div.className = 'bitacora-item';
    
    let icono = '';
    let color = '#4CAF50';
    
    switch(evento.tipo) {
      case 'login':
        icono = 'üîê';
        color = '#2196F3';
        break;
      case 'seccion':
        icono = 'üìÇ';
        color = '#FF9800';
        break;
      case 'accion':
        icono = '‚úèÔ∏è';
        color = '#4CAF50';
        break;
      default:
        icono = 'üìù';
    }
    
    div.style.borderLeftColor = color;
    
    div.innerHTML = `
      <div style="display: flex; justify-content: between; align-items: center;">
        <span class="bitacora-tipo">${icono} ${evento.tipo.toUpperCase()}</span>
        <span class="bitacora-fecha">${evento.fecha}</span>
      </div>
      <div class="bitacora-detalles">
        <strong>Usuario:</strong> ${escapeHtml(evento.usuario)}<br>
        <strong>M√≥dulo:</strong> ${escapeHtml(evento.modulo)}<br>
        <strong>Detalles:</strong> ${escapeHtml(evento.detalles)}
      </div>
    `;
    
    cont.appendChild(div);
  });
}

function filtrarBitacora(filtro) {
  mostrarBitacora(filtro);
}

function limpiarBitacora() {
  // Verificar permisos
  if (currentUser.tipo !== 'admin') {
    alert('No tiene permisos para realizar esta acci√≥n');
    return;
  }

  if (confirm('¬øEst√° seguro de que desea limpiar toda la bit√°cora? Esta acci√≥n no se puede deshacer.')) {
    localStorage.setItem('bitacora', '[]');
    mostrarBitacora();
    registrarBitacora('accion', 'Bit√°cora', 'Bit√°cora limpiada completamente');
  }
}

function exportarBitacoraExcel() {
  // Verificar permisos
  if (currentUser.tipo !== 'admin') {
    alert('No tiene permisos para realizar esta acci√≥n');
    return;
  }

  let bitacora = JSON.parse(localStorage.getItem('bitacora') || '[]');
  const columnas = ['fecha', 'usuario', 'tipo', 'modulo', 'detalles'];
  const nombresColumnas = ['Fecha', 'Usuario', 'Tipo', 'M√≥dulo', 'Detalles'];
  exportarExcel(bitacora, 'bitacora', columnas, nombresColumnas);
  
  registrarBitacora('accion', 'Bit√°cora', 'Bit√°cora exportada a Excel');
}

/* -----------------------------------------
  FUNCI√ìN DE EMERGENCIA PARA RESTABLECER ADMIN
  (Ejecutar en la consola del navegador)
----------------------------------------- */
function restablecerAdmin() {
  let usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');
  
  // Buscar el usuario admin
  const adminIndex = usuarios.findIndex(u => u.username === 'admin');
  
  if (adminIndex !== -1) {
    // Restablecer contrase√±a a 'admin123'
    usuarios[adminIndex].password = 'admin123';
    usuarios[adminIndex].fechaModificacion = new Date().toLocaleString('es-ES');
    
    localStorage.setItem('usuarios', JSON.stringify(usuarios));
    console.log('‚úÖ Contrase√±a de admin restablecida a: admin123');
    console.log('Usuarios actualizados:', usuarios);
  } else {
    // Crear usuario admin si no existe
    usuarios.push({
      id: 1,
      username: 'admin',
      password: 'admin123',
      tipo: 'admin',
      fechaCreacion: new Date().toLocaleString('es-ES'),
      activo: true
    });
    localStorage.setItem('usuarios', JSON.stringify(usuarios));
    console.log('‚úÖ Usuario admin creado con contrase√±a: admin123');
  }
}

/* -----------------------------------------
  Datos iniciales (arrays persistidos en localStorage)
----------------------------------------- */
let alumnos = JSON.parse(localStorage.getItem('alumnos') || '[]');
let padres = JSON.parse(localStorage.getItem('padres') || '[]');
let grupos = JSON.parse(localStorage.getItem('grupos') || '[]');
let reuniones = JSON.parse(localStorage.getItem('reuniones') || '[]');
let pagos = JSON.parse(localStorage.getItem('pagos') || '[]');

let editIndex = {
  alumno: null,
  padre: null,
  grupo: null,
  reunion: null,
  pago: null
};

/* -------------------------
  Util: mostrar mensaje en bot√≥n
  recibe el elemento bot√≥n (btnEl) y el texto temporal
------------------------- */
function tempSaved(btnEl, text='‚úÖ Guardado', ms=2000){
  const original = btnEl.textContent;
  btnEl.textContent = text;
  btnEl.disabled = true;
  btnEl.classList.add('saving');
  setTimeout(() => { 
    btnEl.textContent = original; 
    btnEl.disabled = false; 
    btnEl.classList.remove('saving');
  }, ms);
}

/* -------------------------
  Navegaci√≥n
------------------------- */
function abrirModulo(id){
  document.getElementById('menu').style.display='none';
  document.querySelectorAll('.modulo').forEach(m => m.classList.remove('active'));
  const sec = document.getElementById(id);
  sec.classList.add('active');
  
  // Registrar acceso a secci√≥n en la bit√°cora
  let nombreModulo = '';
  switch(id) {
    case 'alumnos': nombreModulo = 'Alumnos'; break;
    case 'padres': nombreModulo = 'Padres/Tutores'; break;
    case 'grupos': nombreModulo = 'Grupos'; break;
    case 'reuniones': nombreModulo = 'Reuniones'; break;
    case 'pagos': nombreModulo = 'Pagos'; break;
    case 'usuarios': nombreModulo = 'Usuarios'; break;
    case 'bitacora': nombreModulo = 'Bit√°cora'; break;
    default: nombreModulo = id;
  }
  
  registrarBitacora('seccion', nombreModulo, `Accedi√≥ a la secci√≥n ${nombreModulo}`);
  
  // cuando abrimos, recargar datos √∫tiles
  if(id==='alumnos'){ cargarPadresSelect(); mostrarAlumnos(); }
  if(id==='padres'){ cargarGruposSelect(); mostrarPadres(); }
  if(id==='grupos'){ mostrarGrupos(); }
  if(id==='reuniones'){ 
    cargarFiltroGruposReunion(); 
    cargarPadresCheck(); 
    mostrarReuniones(); 
  }
  if(id==='pagos'){ cargarAlumnosPago(); mostrarPagos(); }
  if(id==='usuarios'){ mostrarUsuarios(); }
  if(id==='bitacora'){ mostrarBitacora(); }
}

function volverMenu(){
  document.querySelectorAll('.modulo').forEach(m => m.classList.remove('active'));
  document.getElementById('menu').style.display = 'flex';
}

// El resto del c√≥digo para alumnos, padres, grupos, reuniones, pagos, etc.
// se mantiene igual que en la versi√≥n anterior...

/* -------------------------
  ALUMNOS
------------------------- */
function guardarAlumno(btn){
  // Verificar permisos
  if (currentUser.tipo !== 'admin' && currentUser.tipo !== 'operador') {
    alert('No tiene permisos para realizar esta acci√≥n');
    return;
  }

  const nombre = document.getElementById('nombreAlumno').value.trim();
  const padre = document.getElementById('padreAlumno').value;
  const comentarios = document.getElementById('comentariosAlumno').value.trim();
  if(!nombre) { alert('El nombre del alumno es obligatorio'); return; }

  if(editIndex.alumno !== null){
    // Edici√≥n
    const alumnoAnterior = alumnos[editIndex.alumno].nombre;
    alumnos[editIndex.alumno] = { nombre, padre, comentarios };
    editIndex.alumno = null;
    registrarBitacora('accion', 'Alumnos', `Edit√≥ alumno: ${alumnoAnterior} -> ${nombre}`);
  } else {
    // Nuevo
    alumnos.push({ nombre, padre, comentarios });
    registrarBitacora('accion', 'Alumnos', `Agreg√≥ nuevo alumno: ${nombre}`);
  }
  
  localStorage.setItem('alumnos', JSON.stringify(alumnos));
  tempSaved(btn);
  limpiarAlumno();
  mostrarAlumnos();
  cargarAlumnosPago(); // actualizar selector de pagos
}

function limpiarAlumno(){
  document.getElementById('nombreAlumno').value='';
  document.getElementById('padreAlumno').value='';
  document.getElementById('comentariosAlumno').value='';
}

function mostrarAlumnos(){
  const cont = document.getElementById('listaAlumnos');
  cont.innerHTML = '';
  const q = document.getElementById('buscarAlumno').value.trim().toLowerCase();
  const lista = alumnos.filter(a => !q || a.nombre.toLowerCase().includes(q));
  if(lista.length === 0){ cont.innerHTML = '<div class="item">No hay alumnos.</div>'; return; }
  lista.forEach((a, i) => {
    const idx = alumnos.indexOf(a);
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `<strong>${escapeHtml(a.nombre)}</strong>
      <div class="detalles">
        <p><b>Padre/Tutor:</b> ${escapeHtml(a.padre||'-')}</p>
        <p><b>Comentarios:</b> ${escapeHtml(a.comentarios||'-')}</p>
        <div class="acciones">
          <button class="edit admin-only operador-only" onclick="editarAlumno(${idx})">Editar</button>
          <button class="del admin-only operador-only" onclick="eliminarAlumno(${idx})">Eliminar</button>
        </div>
      </div>`;
    div.onclick = (e) => {
      // evitar toggle si se clicke√≥ un bot√≥n interno
      if(e.target.tagName.toLowerCase() === 'button') return;
      const det = div.querySelector('.detalles');
      det.style.display = det.style.display === 'block' ? 'none' : 'block';
    };
    cont.appendChild(div);
  });
  
  // Aplicar permisos de visualizaci√≥n
  configurarPermisosPorRol(currentUser.tipo);
}

function editarAlumno(i){
  // Verificar permisos
  if (currentUser.tipo !== 'admin' && currentUser.tipo !== 'operador') {
    alert('No tiene permisos para realizar esta acci√≥n');
    return;
  }

  const a = alumnos[i];
  document.getElementById('nombreAlumno').value = a.nombre;
  document.getElementById('padreAlumno').value = a.padre || '';
  document.getElementById('comentariosAlumno').value = a.comentarios || '';
  editIndex.alumno = i;
  abrirModulo('alumnos');
}

function eliminarAlumno(i){
  // Verificar permisos
  if (currentUser.tipo !== 'admin' && currentUser.tipo !== 'operador') {
    alert('No tiene permisos para realizar esta acci√≥n');
    return;
  }

  const alumno = alumnos[i].nombre;
  if(confirm(`¬øEst√° seguro de eliminar al alumno: ${alumno}?`)) {
    alumnos.splice(i,1);
    localStorage.setItem('alumnos', JSON.stringify(alumnos));
    mostrarAlumnos();
    cargarAlumnosPago();
    registrarBitacora('accion', 'Alumnos', `Elimin√≥ alumno: ${alumno}`);
  }
}
document.getElementById('buscarAlumno').addEventListener('input', mostrarAlumnos);

/* cargar padres en select (para Alumnos) */
function cargarPadresSelect(){
  const sel = document.getElementById('padreAlumno');
  sel.innerHTML = '<option value="">Seleccionar padre/tutor</option>';
  padres.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.nombre;
    opt.textContent = p.nombre;
    sel.appendChild(opt);
  });
}

/* -------------------------
  PADRES
------------------------- */
function guardarPadre(btn){
  // Verificar permisos
  if (currentUser.tipo !== 'admin' && currentUser.tipo !== 'operador') {
    alert('No tiene permisos para realizar esta acci√≥n');
    return;
  }

  const nombre = document.getElementById('nombrePadre').value.trim();
  const telefono = document.getElementById('telefonoPadre').value.trim();
  const grupo = document.getElementById('grupoPadre').value;
  if(!nombre){ alert('El nombre del padre/tutor es obligatorio'); return; }

  if(editIndex.padre !== null){
    // Edici√≥n
    const padreAnterior = padres[editIndex.padre].nombre;
    padres[editIndex.padre] = { nombre, telefono, grupo };
    editIndex.padre = null;
    registrarBitacora('accion', 'Padres', `Edit√≥ padre/tutor: ${padreAnterior} -> ${nombre}`);
  } else {
    // Nuevo
    padres.push({ nombre, telefono, grupo });
    registrarBitacora('accion', 'Padres', `Agreg√≥ nuevo padre/tutor: ${nombre}`);
  }

  localStorage.setItem('padres', JSON.stringify(padres));
  tempSaved(btn);
  limpiarPadre();
  mostrarPadres();
  cargarPadresSelect(); // actualizar select de alumnos
  cargarPadresCheck();  // actualizar check list en reuniones
  cargarPadresEnSelect(); // actualizar pagos si usa padres
}

function limpiarPadre(){
  document.getElementById('nombrePadre').value='';
  document.getElementById('telefonoPadre').value='';
  document.getElementById('grupoPadre').value='';
}

function mostrarPadres(){
  const cont = document.getElementById('listaPadres');
  cont.innerHTML = '';
  const q = document.getElementById('buscarPadre').value.trim().toLowerCase();
  const lista = padres.filter(p => !q || p.nombre.toLowerCase().includes(q));
  if(lista.length === 0){ cont.innerHTML = '<div class="item">No hay padres/tutores.</div>'; return; }
  lista.forEach((p,i) => {
    const idx = padres.indexOf(p);
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `<strong>${escapeHtml(p.nombre)}</strong>
      <div class="detalles">
        <p><b>Tel√©fono:</b> ${escapeHtml(p.telefono||'-')}</p>
        <p><b>Grupo:</b> ${escapeHtml(p.grupo||'-')}</p>
        <div class="acciones">
          <button class="edit admin-only operador-only" onclick="editarPadre(${idx})">Editar</button>
          <button class="del admin-only operador-only" onclick="eliminarPadre(${idx})">Eliminar</button>
        </div>
      </div>`;
    div.onclick = (e) => {
      if(e.target.tagName.toLowerCase() === 'button') return;
      const det = div.querySelector('.detalles');
      det.style.display = det.style.display === 'block' ? 'none' : 'block';
    };
    cont.appendChild(div);
  });
  
  // Aplicar permisos de visualizaci√≥n
  configurarPermisosPorRol(currentUser.tipo);
}

function editarPadre(i){
  // Verificar permisos
  if (currentUser.tipo !== 'admin' && currentUser.tipo !== 'operador') {
    alert('No tiene permisos para realizar esta acci√≥n');
    return;
  }

  const p = padres[i];
  document.getElementById('nombrePadre').value = p.nombre;
  document.getElementById('telefonoPadre').value = p.telefono || '';
  document.getElementById('grupoPadre').value = p.grupo || '';
  editIndex.padre = i;
  abrirModulo('padres');
}

function eliminarPadre(i){
  // Verificar permisos
  if (currentUser.tipo !== 'admin' && currentUser.tipo !== 'operador') {
    alert('No tiene permisos para realizar esta acci√≥n');
    return;
  }

  const padre = padres[i].nombre;
  if(confirm(`¬øEst√° seguro de eliminar al padre/tutor: ${padre}?`)){
    padres.splice(i,1);
    localStorage.setItem('padres', JSON.stringify(padres));
    mostrarPadres();
    cargarPadresSelect();
    cargarPadresCheck();
    cargarPadresEnSelect();
    registrarBitacora('accion', 'Padres', `Elimin√≥ padre/tutor: ${padre}`);
  }
}
document.getElementById('buscarPadre').addEventListener('input', mostrarPadres);

/* cargar grupos en select (para Padres) */
function cargarGruposSelect(){
  const sel = document.getElementById('grupoPadre');
  sel.innerHTML = '<option value="">Seleccionar grupo</option>';
  grupos.forEach(g=>{
    const opt = document.createElement('option');
    opt.value = g.nombre;
    opt.textContent = g.nombre;
    sel.appendChild(opt);
  });
}

/* -------------------------
  GRUPOS
------------------------- */
function guardarGrupo(btn){
  // Verificar permisos
  if (currentUser.tipo !== 'admin' && currentUser.tipo !== 'operador') {
    alert('No tiene permisos para realizar esta acci√≥n');
    return;
  }

  const nombre = document.getElementById('nombreGrupo').value.trim();
  const descripcion = document.getElementById('descripcionGrupo').value.trim();
  if(!nombre){ alert('El nombre del grupo es obligatorio'); return; }

  if(editIndex.grupo !== null){
    // Edici√≥n
    const grupoAnterior = grupos[editIndex.grupo].nombre;
    grupos[editIndex.grupo] = { nombre, descripcion };
    editIndex.grupo = null;
    registrarBitacora('accion', 'Grupos', `Edit√≥ grupo: ${grupoAnterior} -> ${nombre}`);
  } else {
    // Nuevo
    grupos.push({ nombre, descripcion });
    registrarBitacora('accion', 'Grupos', `Agreg√≥ nuevo grupo: ${nombre}`);
  }

  localStorage.setItem('grupos', JSON.stringify(grupos));
  tempSaved(btn);
  limpiarGrupo();
  mostrarGrupos();
  cargarGruposSelect();
}

function limpiarGrupo(){
  document.getElementById('nombreGrupo').value='';
  document.getElementById('descripcionGrupo').value='';
}

function mostrarGrupos(){
  const cont = document.getElementById('listaGrupos');
  cont.innerHTML = '';
  const q = document.getElementById('buscarGrupo').value.trim().toLowerCase();
  const lista = grupos.filter(g => !q || g.nombre.toLowerCase().includes(q));
  if(lista.length === 0){ cont.innerHTML = '<div class="item">No hay grupos.</div>'; return; }
  lista.forEach((g,i)=>{
    const idx = grupos.indexOf(g);
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `<strong>${escapeHtml(g.nombre)}</strong>
      <div class="detalles">
        <p><b>Descripci√≥n:</b> ${escapeHtml(g.descripcion||'-')}</p>
        <div class="acciones">
          <button class="edit admin-only operador-only" onclick="editarGrupo(${idx})">Editar</button>
          <button class="del admin-only operador-only" onclick="eliminarGrupo(${idx})">Eliminar</button>
        </div>
      </div>`;
    div.onclick = (e) => {
      if(e.target.tagName.toLowerCase() === 'button') return;
      const det = div.querySelector('.detalles');
      det.style.display = det.style.display === 'block' ? 'none' : 'block';
    };
    cont.appendChild(div);
  });
  
  // Aplicar permisos de visualizaci√≥n
  configurarPermisosPorRol(currentUser.tipo);
}
function editarGrupo(i){
  // Verificar permisos
  if (currentUser.tipo !== 'admin' && currentUser.tipo !== 'operador') {
    alert('No tiene permisos para realizar esta acci√≥n');
    return;
  }

  const g = grupos[i];
  document.getElementById('nombreGrupo').value = g.nombre;
  document.getElementById('descripcionGrupo').value = g.descripcion || '';
  editIndex.grupo = i;
  abrirModulo('grupos');
}
function eliminarGrupo(i){
  // Verificar permisos
  if (currentUser.tipo !== 'admin' && currentUser.tipo !== 'operador') {
    alert('No tiene permisos para realizar esta acci√≥n');
    return;
  }

  const grupo = grupos[i].nombre;
  if(confirm(`¬øEst√° seguro de eliminar el grupo: ${grupo}?`)){
    grupos.splice(i,1);
    localStorage.setItem('grupos', JSON.stringify(grupos));
    mostrarGrupos();
    cargarGruposSelect();
    registrarBitacora('accion', 'Grupos', `Elimin√≥ grupo: ${grupo}`);
  }
}
document.getElementById('buscarGrupo').addEventListener('input', mostrarGrupos);

/* -------------------------
  REUNIONES (padres check)
------------------------- */
function cargarFiltroGruposReunion() {
  const filtro = document.getElementById('filtroGrupoReunion');
  filtro.innerHTML = '<option value="">Todos los grupos</option>';
  grupos.forEach(g => {
    const opt = document.createElement('option');
    opt.value = g.nombre;
    opt.textContent = g.nombre;
    filtro.appendChild(opt);
  });
}

function cargarPadresCheck(presentes=[]){
  const cont = document.getElementById('listaPadresCheck');
  cont.innerHTML = '';
  if(padres.length === 0){ 
    cont.innerHTML = '<div class="item">No hay padres registrados.</div>'; 
    return; 
  }
  
  padres.forEach(p => {
    const div = document.createElement('div');
    div.className = 'check-item';
    div.setAttribute('data-grupo', p.grupo || '');
    const id = 'chk_'+slugify(p.nombre);
    div.innerHTML = `<input id="${id}" type="checkbox" value="${escapeHtml(p.nombre)}" ${presentes.includes(p.nombre) ? 'checked' : ''}> 
                     <label for="${id}">${escapeHtml(p.nombre)}</label>`;
    cont.appendChild(div);
  });
  
  // Aplicar filtro actual despu√©s de cargar
  filtrarPadresPorGrupo();
}

function filtrarPadresPorGrupo() {
  const filtro = document.getElementById('filtroGrupoReunion').value;
  const items = document.querySelectorAll('#listaPadresCheck .check-item');
  
  items.forEach(item => {
    const grupoPadre = item.getAttribute('data-grupo') || '';
    if (!filtro || grupoPadre === filtro) {
      item.style.display = 'flex';
    } else {
      item.style.display = 'none';
    }
  });
}

function guardarReunion(btn){
  // Verificar permisos
  if (currentUser.tipo !== 'admin' && currentUser.tipo !== 'operador') {
    alert('No tiene permisos para realizar esta acci√≥n');
    return;
  }

  const titulo = document.getElementById('tituloReunion').value.trim();
  const fecha = document.getElementById('fechaReunion').value;
  const hora = document.getElementById('horaReunion').value;
  const observaciones = document.getElementById('observacionesReunion').value.trim();
  const checkboxes = document.querySelectorAll('#listaPadresCheck input[type="checkbox"]');
  const presentes = [];
  const ausentes = [];
  
  checkboxes.forEach(cb => { 
    if(cb.checked) {
      presentes.push(cb.value);
    } else {
      ausentes.push(cb.value);
    }
  });

  if(!titulo){ alert('El t√≠tulo de la reuni√≥n es obligatorio'); return; }

  if(editIndex.reunion !== null){
    // Edici√≥n
    const reunionAnterior = reuniones[editIndex.reunion].titulo;
    reuniones[editIndex.reunion] = { titulo, fecha, hora, observaciones, presentes, ausentes };
    editIndex.reunion = null;
    registrarBitacora('accion', 'Reuniones', `Edit√≥ reuni√≥n: ${reunionAnterior} -> ${titulo}`);
  } else {
    // Nueva
    reuniones.push({ titulo, fecha, hora, observaciones, presentes, ausentes });
    registrarBitacora('accion', 'Reuniones', `Agreg√≥ nueva reuni√≥n: ${titulo} con ${presentes.length} presentes`);
  }

  localStorage.setItem('reuniones', JSON.stringify(reuniones));
  tempSaved(btn);
  limpiarReunion();
  mostrarReuniones();
}

function limpiarReunion(){
  document.getElementById('tituloReunion').value='';
  document.getElementById('fechaReunion').value='';
  document.getElementById('horaReunion').value='';
  document.getElementById('observacionesReunion').value='';
  document.getElementById('filtroGrupoReunion').value = '';
  cargarPadresCheck();
}

function mostrarReuniones(){
  const cont = document.getElementById('listaReuniones');
  cont.innerHTML = '';
  const q = document.getElementById('buscarReunion').value.trim().toLowerCase();
  const lista = reuniones.filter(r => !q || r.titulo.toLowerCase().includes(q));
  if(lista.length === 0){ cont.innerHTML = '<div class="item">No hay reuniones.</div>'; return; }
  lista.forEach((r,i) => {
    const idx = reuniones.indexOf(r);
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `<strong>${escapeHtml(r.titulo)}</strong>
      <div class="detalles">
        <p><b>Fecha:</b> ${escapeHtml(r.fecha||'-')}</p>
        <p><b>Hora:</b> ${escapeHtml(r.hora||'-')}</p>
        <p><b>Observaciones:</b> ${escapeHtml(r.observaciones||'-')}</p>
        <p><b>Presentes:</b> ${r.presentes && r.presentes.length ? escapeHtml(r.presentes.join(', ')) : '-'}</p>
        <p><b>Ausentes:</b> ${r.ausentes && r.ausentes.length ? escapeHtml(r.ausentes.join(', ')) : '-'}</p>
        <div class="acciones">
          <button class="edit admin-only operador-only" onclick="editarReunion(${idx})">Editar</button>
          <button class="del admin-only operador-only" onclick="eliminarReunion(${idx})">Eliminar</button>
        </div>
      </div>`;
    div.onclick = (e) => { 
      if(e.target.tagName.toLowerCase()==='button') return; 
      const det = div.querySelector('.detalles'); 
      det.style.display = det.style.display === 'block' ? 'none' : 'block'; 
    };
    cont.appendChild(div);
  });
  
  // Aplicar permisos de visualizaci√≥n
  configurarPermisosPorRol(currentUser.tipo);
}
function editarReunion(i){
  // Verificar permisos
  if (currentUser.tipo !== 'admin' && currentUser.tipo !== 'operador') {
    alert('No tiene permisos para realizar esta acci√≥n');
    return;
  }

  const r = reuniones[i];
  document.getElementById('tituloReunion').value = r.titulo;
  document.getElementById('fechaReunion').value = r.fecha || '';
  document.getElementById('horaReunion').value = r.hora || '';
  document.getElementById('observacionesReunion').value = r.observaciones || '';
  editIndex.reunion = i;
  abrirModulo('reuniones');
  cargarPadresCheck(r.presentes || []);
}
function eliminarReunion(i){
  // Verificar permisos
  if (currentUser.tipo !== 'admin' && currentUser.tipo !== 'operador') {
    alert('No tiene permisos para realizar esta acci√≥n');
    return;
  }

  const reunion = reuniones[i].titulo;
  if(confirm(`¬øEst√° seguro de eliminar la reuni√≥n: ${reunion}?`)){
    reuniones.splice(i,1);
    localStorage.setItem('reuniones', JSON.stringify(reuniones));
    mostrarReuniones();
    registrarBitacora('accion', 'Reuniones', `Elimin√≥ reuni√≥n: ${reunion}`);
  }
}
document.getElementById('buscarReunion').addEventListener('input', mostrarReuniones);

/* -------------------------
  PAGOS
------------------------- */
function cargarAlumnosPago(){
  const sel = document.getElementById('alumnoPago');
  sel.innerHTML = '<option value="">Seleccionar alumno</option>';
  alumnos.forEach(a => {
    const opt = document.createElement('option');
    opt.value = a.nombre;
    opt.textContent = a.nombre;
    sel.appendChild(opt);
  });
}

function guardarPago(btn){
  // Verificar permisos
  if (currentUser.tipo !== 'admin' && currentUser.tipo !== 'operador') {
    alert('No tiene permisos para realizar esta acci√≥n');
    return;
  }

  const alumno = document.getElementById('alumnoPago').value;
  const monto = document.getElementById('montoPago').value.trim();
  const fecha = document.getElementById('fechaPago').value;
  const concepto = document.getElementById('conceptoPago').value.trim();

  if(!alumno || !monto){ alert('Seleccionar alumno y monto'); return; }

  if(editIndex.pago !== null){
    // Edici√≥n
    const pagoAnterior = pagos[editIndex.pago].alumno;
    pagos[editIndex.pago] = { alumno, monto, fecha, concepto };
    editIndex.pago = null;
    registrarBitacora('accion', 'Pagos', `Edit√≥ pago de: ${pagoAnterior} -> ${alumno}, monto: ${monto}`);
  } else {
    // Nuevo
    pagos.push({ alumno, monto, fecha, concepto });
    registrarBitacora('accion', 'Pagos', `Registr√≥ nuevo pago de: ${alumno}, monto: ${monto}`);
  }

  localStorage.setItem('pagos', JSON.stringify(pagos));
  tempSaved(btn);
  limpiarPago();
  mostrarPagos();
}

function limpiarPago(){
  document.getElementById('alumnoPago').value='';
  document.getElementById('montoPago').value='';
  document.getElementById('fechaPago').value='';
  document.getElementById('conceptoPago').value='';
}

function mostrarPagos(){
  const cont = document.getElementById('listaPagos');
  cont.innerHTML = '';
  const q = document.getElementById('buscarPago').value.trim().toLowerCase();
  const lista = pagos.filter(p => !q || p.alumno.toLowerCase().includes(q));
  if(lista.length === 0){ cont.innerHTML = '<div class="item">No hay pagos registrados.</div>'; return; }
  lista.forEach((p,i) => {
    const idx = pagos.indexOf(p);
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `<strong>${escapeHtml(p.alumno)}</strong> - ${escapeHtml(p.monto)}
      <div class="detalles">
        <p><b>Fecha:</b> ${escapeHtml(p.fecha||'-')}</p>
        <p><b>Concepto:</b> ${escapeHtml(p.concepto||'-')}</p>
        <div class="acciones">
          <button class="edit admin-only operador-only" onclick="editarPago(${idx})">Editar</button>
          <button class="del admin-only operador-only" onclick="eliminarPago(${idx})">Eliminar</button>
        </div>
      </div>`;
    div.onclick = (e) => { 
      if(e.target.tagName.toLowerCase()==='button') return; 
      const det = div.querySelector('.detalles'); 
      det.style.display = det.style.display === 'block' ? 'none' : 'block'; 
    };
    cont.appendChild(div);
  });
  
  // Aplicar permisos de visualizaci√≥n
  configurarPermisosPorRol(currentUser.tipo);
}
function editarPago(i){
  // Verificar permisos
  if (currentUser.tipo !== 'admin' && currentUser.tipo !== 'operador') {
    alert('No tiene permisos para realizar esta acci√≥n');
    return;
  }

  const p = pagos[i];
  document.getElementById('alumnoPago').value = p.alumno;
  document.getElementById('montoPago').value = p.monto;
  document.getElementById('fechaPago').value = p.fecha || '';
  document.getElementById('conceptoPago').value = p.concepto || '';
  editIndex.pago = i;
  abrirModulo('pagos');
}
function eliminarPago(i){
  // Verificar permisos
  if (currentUser.tipo !== 'admin' && currentUser.tipo !== 'operador') {
    alert('No tiene permisos para realizar esta acci√≥n');
    return;
  }

  const pago = pagos[i].alumno;
  const monto = pagos[i].monto;
  if(confirm(`¬øEst√° seguro de eliminar el pago de: ${pago} por ${monto}?`)){
    pagos.splice(i,1);
    localStorage.setItem('pagos', JSON.stringify(pagos));
    mostrarPagos();
    registrarBitacora('accion', 'Pagos', `Elimin√≥ pago de: ${pago}, monto: ${monto}`);
  }
}
document.getElementById('buscarPago').addEventListener('input', mostrarPagos);

/* -------------------------
  FUNCIONES DE EXPORTACI√ìN A EXCEL
------------------------- */
function exportarExcel(datos, nombreArchivo, columnas, nombresColumnas) {
  // Verificar permisos
  if (currentUser.tipo !== 'admin' && currentUser.tipo !== 'operador') {
    alert('No tiene permisos para realizar esta acci√≥n');
    return;
  }

  if (datos.length === 0) {
    alert(`No hay datos para exportar en ${nombreArchivo}`);
    return;
  }

  // Crear contenido HTML para Excel
  let html = `
    <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
    <head>
      <meta charset="UTF-8">
      <title>${nombreArchivo}</title>
      <!--[if gte mso 9]>
      <xml>
        <x:ExcelWorkbook>
          <x:ExcelWorksheets>
            <x:ExcelWorksheet>
              <x:Name>${nombreArchivo}</x:Name>
              <x:WorksheetOptions>
                <x:DisplayGridlines/>
              </x:WorksheetOptions>
            </x:ExcelWorksheet>
          </x:ExcelWorksheets>
        </x:ExcelWorkbook>
      </xml>
      <![endif]-->
      <style>
        table {
          border-collapse: collapse;
          width: 100%;
        }
        th {
          background-color: #4CAF50;
          color: white;
          font-weight: bold;
          padding: 8px;
          text-align: left;
          border: 1px solid #ddd;
        }
        td {
          padding: 8px;
          border: 1px solid #ddd;
        }
        tr:nth-child(even) {
          background-color: #f2f2f2;
        }
      </style>
    </head>
    <body>
      <table>
        <thead>
          <tr>
  `;

  // Agregar encabezados
  nombresColumnas.forEach(col => {
    html += `<th>${col}</th>`;
  });
  html += `</tr></thead><tbody>`;

  // Agregar datos
  datos.forEach(item => {
    html += '<tr>';
    columnas.forEach(col => {
      let valor = item[col] || '';
      // Si es un array, convertirlo a string
      if (Array.isArray(valor)) {
        valor = valor.join(', ');
      }
      html += `<td>${escapeHtml(valor)}</td>`;
    });
    html += '</tr>';
  });

  html += `</tbody></table></body></html>`;

  // Crear y descargar archivo
  const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', `${nombreArchivo}_${new Date().toISOString().split('T')[0]}.xls`);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  // Registrar en bit√°cora
  registrarBitacora('accion', 'Exportaci√≥n', `Export√≥ ${nombreArchivo} a Excel`);
}

function exportarAlumnosExcel() {
  const columnas = ['nombre', 'padre', 'comentarios'];
  const nombresColumnas = ['Nombre', 'Padre/Tutor', 'Comentarios'];
  exportarExcel(alumnos, 'alumnos', columnas, nombresColumnas);
}

function exportarPadresExcel() {
  const columnas = ['nombre', 'telefono', 'grupo'];
  const nombresColumnas = ['Nombre', 'Tel√©fono', 'Grupo'];
  exportarExcel(padres, 'padres', columnas, nombresColumnas);
}

function exportarGruposExcel() {
  const columnas = ['nombre', 'descripcion'];
  const nombresColumnas = ['Nombre', 'Descripci√≥n'];
  exportarExcel(grupos, 'grupos', columnas, nombresColumnas);
}

function exportarReunionesExcel() {
  const columnas = ['titulo', 'fecha', 'hora', 'observaciones', 'presentes', 'ausentes'];
  const nombresColumnas = ['T√≠tulo', 'Fecha', 'Hora', 'Observaciones', 'Presentes', 'Ausentes'];
  exportarExcel(reuniones, 'reuniones', columnas, nombresColumnas);
}

function exportarPagosExcel() {
  const columnas = ['alumno', 'monto', 'fecha', 'concepto'];
  const nombresColumnas = ['Alumno', 'Monto (Bs)', 'Fecha', 'Concepto'];
  exportarExcel(pagos, 'pagos', columnas, nombresColumnas);
}

function exportarDatos() {
  // Verificar permisos
  if (currentUser.tipo !== 'admin' && currentUser.tipo !== 'operador') {
    alert('No tiene permisos para realizar esta acci√≥n');
    return;
  }

  if (confirm('¬øExportar todos los datos a archivos Excel? Se descargar√°n 5 archivos.')) {
    exportarAlumnosExcel();
    setTimeout(() => exportarPadresExcel(), 300);
    setTimeout(() => exportarGruposExcel(), 600);
    setTimeout(() => exportarReunionesExcel(), 900);
    setTimeout(() => exportarPagosExcel(), 1200);
  }
}

/* -------------------------
  UTILIDADES
------------------------- */
function escapeHtml(str){
  if(!str && str !== 0) return '';
  return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
}
function slugify(s){ return (s||'').toLowerCase().replace(/\s+/g,'_').replace(/[^\w\-]+/g,''); }

/* cargar selects globales */
function cargarPadresEnSelect(){
  // for payments if you want parents - not used currently but available
  const sel = document.getElementById('padrePago');
  if(!sel) return;
  sel.innerHTML = '<option value="">Seleccione un padre</option>';
  padres.forEach(p => {
    const o = document.createElement('option'); o.value = p.nombre; o.textContent = p.nombre; sel.appendChild(o);
  });
}

/* Inicializar pantallas con datos guardados */
function initApp() {
  // Inicializar usuarios si no existen
  inicializarUsuarios();
  
  // populate basic lists so when user opens a module they see current data
  cargarPadresSelect();
  cargarGruposSelect();
  cargarFiltroGruposReunion();
  cargarPadresCheck();
  cargarAlumnosPago();
  mostrarAlumnos();
  mostrarPadres();
  mostrarGrupos();
  mostrarReuniones();
  mostrarPagos();
  mostrarUsuarios();
  
  // Event listener para el filtro de grupos en reuniones
  document.getElementById('filtroGrupoReunion').addEventListener('change', filtrarPadresPorGrupo);
}

// Inicializar la aplicaci√≥n cuando se carga la p√°gina - CORREGIDO
document.addEventListener('DOMContentLoaded', function() {
  // Inicializar usuarios autom√°ticamente al cargar la p√°gina
  inicializarUsuarios();
  console.log("Aplicaci√≥n inicializada, usuario admin creado si no exist√≠a");
});
</script>
</body>
</html>